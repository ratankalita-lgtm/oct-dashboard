<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OCT Protocol Dashboard â€“ Ratan Kalita</title>

<style>
.ddx-chip{ border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; user-select:none; transition:.15s; color:#93c5fd; font-weight:600;}
.ddx-chip:hover{ background:rgba(255,255,255,.08); }
:root{ --bg:#0b1020; --card:#ffffff; --muted:#6b7280; --border:#e5e7eb; --shadow:0 10px 26px rgba(0,0,0,.14); --accent:#1d4ed8; --accent2:#06b6d4; --danger:#dc2626; }
body{ font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; background: radial-gradient(900px 500px at 20% 0%, rgba(29,78,216,0.16), transparent 60%), radial-gradient(900px 500px at 90% 5%, rgba(6,182,212,0.14), transparent 60%), var(--bg); margin:16px; color:#111; }
.wrap{max-width:1220px;margin:auto;}
header{ background:linear-gradient(135deg,#1d4ed8,#06b6d4); color:white; padding:18px; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.25); position: sticky; top: 10px; z-index: 4; }
header h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.2px}
.sub{font-size:13px;margin-top:6px;opacity:.95;line-height:1.35}

.domain-tabs { display:flex; gap:10px; margin-top:16px; border-bottom:1px solid rgba(255,255,255,.2); padding-bottom:10px; overflow-x:auto;}
.dTab { background:transparent; border:none; color:rgba(255,255,255,.6); font-weight:800; font-size:14px; cursor:pointer; padding:6px 12px; transition:.2s; white-space:nowrap; }
.dTab:hover { color:rgba(255,255,255,.9); }
.dTab.active { color:#fff; background:rgba(255,255,255,.2); border-radius:8px; }

.toolsRow{ display:flex;flex-wrap:wrap;gap:10px;align-items:center; margin-top:14px; }
.searchWrap{ flex:1; min-width:240px; position:relative; }
#search{ width:100%; padding:12px 42px 12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.16); color:#fff; font-size:16px; outline:none; }
#search::placeholder{color:rgba(255,255,255,.75)}
.clearX{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:28px;height:28px; border-radius:10px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.12); color:#fff; cursor:pointer; display:flex;align-items:center;justify-content:center; font-weight:900; }
.clearX:hover{filter:brightness(1.12)}
.btn{ padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.16); color:#fff; font-weight:900; cursor:pointer; }
.btn:hover{filter:brightness(1.10)}
.filterBar{ margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
.filterBtn{ padding:8px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.40); background:rgba(255,255,255,.14); color:white; font-weight:900; cursor:pointer; font-size:12px; }
.filterBtn.active{ background:white; color:#1457ff; box-shadow:0 10px 20px rgba(0,0,0,.18); }
.metaLine{ margin-top:8px; font-size:12px; opacity:.95; }

/* REBALANCED LAYOUT: Left sidebar narrower, right panel wider */
.main{ display:grid; grid-template-columns: 0.85fr 1.3fr; gap:20px; margin-top:16px; align-items:start; }
.grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }

.tile{ background:var(--card); border:1px solid var(--border); padding:14px; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.08); cursor:pointer; transition:.12s; }
.tile:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(29,78,216,.14); border-color: rgba(29,78,216,.25); }
.tileTitle{font-weight:950;font-size:15px;line-height:1.25}
.catPill{ display:inline-flex; margin-top:8px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; font-weight:900; color:#374151; background:#f1f5f9;}
.countRow{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; font-size:12px; color:#374151; font-weight:800; }
.countRow span{ display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; background:#f9fafb; border:1px solid var(--border); }
.panel{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:24px; position: sticky; top: 150px; display:none; }
.panel h2{margin:0 0 10px 0;color:var(--accent)}
.panel h3{ margin:18px 0 6px 0; border-bottom:1px solid #eee; padding-bottom:4px; color:#374151; display:flex; justify-content:space-between; align-items:center; font-size:15px;}
ul{margin:6px 0 0 0;padding-left:20px}
li{margin-bottom:6px;line-height:1.5}
#flagsList li{color:var(--danger);font-weight:700}
.actionRow{ display:flex; gap:8px; flex-wrap:wrap; }
.pBtn{ padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:800; font-size:13px; color:#334155;}
.pBtn:hover{border-color: rgba(29,78,216,.35); background:#f8fafc; color:#1d4ed8; }
@media (max-width: 920px){ .main{grid-template-columns:1fr;} .panel{position:relative; top:auto;} }
.footer{ text-align:center; margin:22px 0 26px 0; color:rgba(255,255,255,.70); font-size:12px; }

/* DRAWER CSS */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:.2s;z-index:60}
.drawer-overlay.open{opacity:1;pointer-events:auto}
.drawer{position:fixed;top:0;right:-420px;width:420px;max-width:92vw;height:100vh;background:#0f172a;border-left:1px solid rgba(148,163,184,.2);z-index:70;transition:.25s;display:flex;flex-direction:column; color:white;}
.drawer.open{right:0}
.drawer-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid rgba(148,163,184,.15);background:linear-gradient(180deg, rgba(59,130,246,.12), rgba(139,92,246,.06))}
.drawer-body{padding:14px;overflow:auto;display:flex;flex-direction:column;gap:12px}
.d-panel{background:rgba(51,65,85,.55);border:1px solid rgba(148,163,184,.12);border-radius:16px;padding:12px}
.panel-title{font-size:12px;color:#94a3b8;margin-bottom:8px;letter-spacing:.02em;text-transform:uppercase}
.row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.row label{font-size:12px;color:#94a3b8}
.row input,.row select{background:rgba(15,23,42,.6);border:1px solid rgba(148,163,184,.18);color:#fff;border-radius:12px;padding:10px 12px;outline:none}
.row input:focus,.row select:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
.chk{display:flex;align-items:center;gap:8px;font-size:12px;color:#fff;background:rgba(15,23,42,.35);padding:8px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.12); cursor:pointer; user-select:none;}
.actions{display:flex;gap:10px;justify-content:flex-end}
.list{display:flex;flex-direction:column;gap:8px}
.item{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px 12px}
.item strong{color:white;font-size:13px}
.item small{color:#94a3b8;font-size:11px}
.item button{padding:6px 10px;font-size:12px; border-radius:8px; border:none; cursor:pointer;}
.hint{margin-top:8px;color:#94a3b8;font-size:12px}
.close-btn{background:transparent; border:none; color:white; font-size:24px; cursor:pointer;}

/* PRINT STYLES */
@media print {
  body { background:#fff !important; color:#000 !important; margin:0 !important; }
  header, .filterBar, .toolsRow, .metaLine, .domain-tabs, .drawer, .drawer-overlay, .footer { display:none !important; }
  .main { display:block !important; margin:0 !important; }
  #tiles { display:none !important; }
  #details { display:block !important; position:static !important; border:none !important; box-shadow:none !important; color:#000 !important; padding:0 !important; }
  .actionRow { display:none !important; }
  h2, h3, li, p, span { color:#000 !important; }
  .d-panel { border: 1px solid #ccc !important; }
  #printPatientLine { display:block !important; }
}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div style="display:flex; justify-content:space-between; align-items:flex-start;">
    <div>
      <h1>Dr. Ratan Kalita</h1>
      <div class="sub">OCT / OCT-A Clinical Protocol Dashboard â€¢ DRI Triton OCTA</div>
    </div>
    <button class="btn" style="background:rgba(0,0,0,0.2)" onclick="openPatients()">ðŸ‘¥ Patients</button>
  </div>

  <div class="domain-tabs">
    <button class="dTab active" onclick="setDomain('All')">All Domains</button>
    <button class="dTab" onclick="setDomain('Retina')">Retina</button>
    <button class="dTab" onclick="setDomain('Optic Nerve')">Optic Nerve</button>
    <button class="dTab" onclick="setDomain('Anterior Segment')">Anterior Segment</button>
  </div>

  <div class="toolsRow">
    <div class="searchWrap">
      <input id="search" placeholder="Search by name, alias, or acronym (e.g., BRVO, DME)..." onkeyup="applyFilters()">
      <div class="clearX" title="Clear" onclick="clearSearch()">Ã—</div>
    </div>
  </div>

  <div class="filterBar" id="categoryFilters"></div>
  <div class="metaLine" id="metaLine"></div>
</header>

<div class="main">
  <div>
    <div id="tiles" class="grid"></div>
  </div>

  <div id="details" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
      <div style="flex:1; padding-right:12px;">
        <h2 id="dxName" style="margin:0 0 6px 0;"></h2>
        <div id="printPatientLine" style="display:none; font-size:12px; color:#111;"></div>
      </div>
      <div class="actionRow">
        <button class="pBtn" type="button" onclick="printProtocol()">ðŸ–¨ Print</button>
        <button class="pBtn" type="button" onclick="openPatients(true)">ðŸ’¾ Save</button>
        <button class="pBtn" type="button" onclick="collapseDetails()">âœ– Close</button>
      </div>
    </div>
    
    <h3>ðŸ“· Structural OCT <span id="octCount"></span></h3>
    <ul id="octList"></ul>

    <h3>ðŸ§¬ OCT-A Protocol <span id="octaCount"></span></h3>
    <ul id="octaList"></ul>

    <h3>ðŸŽ¯ Analysis Targets <span id="tCount"></span></h3>
    <ul id="targetsList"></ul>

    <h3>âš  Red Flags <span id="fCount"></span></h3>
    <ul id="flagsList"></ul>

    <hr style="border:0; border-top:1px solid #e2e8f0; margin:24px 0 16px 0;">

    <div class="d-panel" style="background:#f8fafc; border:1px solid #e2e8f0;">
      <div class="row2" style="gap:20px;">
        <div class="row">
          <label style="font-weight:700; color:#1d4ed8; font-size:13px; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;">1. Clinical Triage</label>
          <select id="triageSelect" style="color:#000; background:#fff; border-color:#cbd5e1; font-weight:600; cursor:pointer;">
            <option value="Routine">Routine</option>
            <option value="Soon">Refer soon</option>
            <option value="Urgent">Urgent</option>
          </select>
          <div class="hint" style="margin-top:8px; display:flex; align-items:center; gap:8px; color:#64748b;">
            <span style="font-weight:700;">Decision:</span>
            <span id="decisionBadge" class="badge" style="font-weight:bold;">â€”</span>
          </div>
        </div>
        <div class="row">
          <label style="font-weight:700; color:#1d4ed8; font-size:13px; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;">2. DDx Suggestions</label>
          <div id="ddxChips" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="footer">Â© Ratan Kalita (Optometry) â€¢ De-identify all images before adding â€¢ Private clinical tool</div>

</div>

<div class="drawer-overlay" id="drawerOverlay" onclick="closePatients(event)"></div>
<aside class="drawer" id="patientDrawer" aria-hidden="true">
  <div class="drawer-header">
    <div>
      <div style="font-weight:700; font-size:16px;">Patients</div>
      <div style="font-size:12px; color:#cbd5e1;">Local follow-ups (offline).</div>
    </div>
    <button class="close-btn" onclick="closePatients()">Ã—</button>
  </div>

  <div class="drawer-body">
    <div class="d-panel">
      <div class="panel-title">Active Patient Context</div>
      <div class="row">
        <label>Patient ID / OPD No</label>
        <input id="p_id" placeholder="e.g. OPD-1203 / Phone" />
      </div>
      <div class="row2">
        <div class="row">
          <label>Age</label>
          <input id="p_age" inputmode="numeric" placeholder="e.g. 58" />
        </div>
        <div class="row">
          <label>Sex</label>
          <select id="p_sex">
            <option value="">â€”</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      
      <div class="row2">
        <div class="row">
          <label>Eye</label>
          <select id="p_eye">
            <option value="OD">OD</option>
            <option value="OS">OS</option>
            <option value="OU">OU</option>
          </select>
        </div>
        <div class="row">
          <label>VA (LogMAR/Snellen)</label>
          <input id="p_va" placeholder="e.g. 6/12" />
        </div>
      </div>
      <div class="row2">
        <div class="row">
          <label>IOP (mmHg)</label>
          <input id="p_iop" inputmode="numeric" placeholder="e.g. 18" />
        </div>
        <div class="row">
          <label>Symptoms / Onset</label>
          <input id="p_symptoms" placeholder="e.g. sudden blur 3 days" />
        </div>
      </div>
      
      <div class="chips" id="findingsWrap">
        <label class="chk"><input type="checkbox" id="p_dm"> Diabetes</label>
        <label class="chk"><input type="checkbox" id="p_htn"> HTN</label>
        <label class="chk"><input type="checkbox" id="p_myopia"> High myopia</label>
        <label class="chk"><input type="checkbox" id="p_steroid"> Steroids</label>
        <label class="chk"><input type="checkbox" id="p_smoke"> Smoker</label>
        <label class="chk" style="border-color: #3b82f6;"><input type="checkbox" data-finding="recent_surgery" id="f_recent_surgery"> Recent Surgery</label>
      </div>

      <div class="row">
        <label>Visit Note</label>
        <input id="p_note" placeholder="Quick clinical note (e.g. baseline, post-injection...)" />
      </div>
      
      <div class="actions" style="margin-top:8px;">
        <button type="button" style="padding:8px 12px; border-radius:8px; cursor:pointer;" onclick="clearPatientForm()">Clear Form</button>
        <button type="button" style="padding:8px 12px; border-radius:8px; cursor:pointer; background:#2563eb; color:white; border:none;" onclick="savePatientAndMaybeVisit()">Save Context</button>
      </div>
      <div id="activeDxHint" class="hint" style="display:none; color:#fbbf24; font-weight:bold; margin-top:10px;"></div>
    </div>

    <div class="d-panel" id="visitTimelinePanel" style="display:none;">
      <div class="panel-title">Visit Timeline</div>
      <div id="visitTimelineList" class="list"></div>
    </div>

    <div class="d-panel">
      <div class="panel-title">Saved Patients</div>
      
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button type="button" style="flex:1; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.15); cursor:pointer;" onclick="exportPatients()">Export</button>
        <button type="button" style="flex:1; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.15); cursor:pointer;" onclick="importPatients()">Import</button>
      </div>

      <input id="patientSearch" placeholder="Search patient ID..." oninput="renderPatientList()" style="width:100%; box-sizing:border-box; background:rgba(15,23,42,.6); border:1px solid rgba(148,163,184,.18); color:#fff; border-radius:12px; padding:10px 12px; margin-bottom:10px;" />
      <div id="patientList" class="list"></div>
    </div>
    
  </div>
</aside>

<script>
// --- GLOBALS & MIGRATION ---
let allDiagnoses = [];
let activeDomain = "All";
let activeCategory = "All";
let currentDx = null;
let triageWasManuallySet = false;
let autoSaveVisitOnPatientSave = false;
const LS_KEY = "octengine_patients_v2"; 

(function migrateV1toV2(){
  const v1 = localStorage.getItem("octengine_patients_v1");
  const v2 = localStorage.getItem("octengine_patients_v2");
  if(v1 && !v2){
    localStorage.setItem("octengine_patients_v2", v1);
  }
})();

// --- HELPERS ---
function getCategory(dx){ return (dx && dx.category) ? dx.category.toString().trim() : "Other"; }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
function listify(v){
  if(Array.isArray(v)) return v.filter(x=>String(x||"").trim().length).map(x=>String(x));
  if(v==null) return [];
  return String(v).split(/\r?\n/).map(x=>x.replace(/^\s*[â€¢\-*]+\s*/,"").trim()).filter(x=>x.length);
}

// Check for text selection (prevent accidental clicks)
function _hasSelection(){
  const s = window.getSelection?.();
  return s && String(s).length > 0;
}

// XSS-Safe Highlighting
function _reEscape(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function highlightTerm(text, term) {
  if(!term) return escapeHtml(text);
  const safeText = escapeHtml(text);
  const tokens = norm(term).split(/\s+/).filter(Boolean).map(_reEscape);
  if(!tokens.length) return safeText;
  const regex = new RegExp(`(${tokens.join('|')})`, 'gi');
  return safeText.replace(regex, `<mark style="background:rgba(29,78,216,0.2); color:#1d4ed8; padding:0 2px; border-radius:3px;">$1</mark>`);
}

// Safe Checkbox Toggle Behavior
document.addEventListener("click", (e)=>{
  const lab = e.target.closest(".chk");
  if(!lab) return;
  const cb = lab.querySelector("input[type=checkbox]");
  if(!cb || cb.disabled) return;
  if(e.target === cb) return;
  cb.checked = !cb.checked;
  cb.dispatchEvent(new Event("change", {bubbles:true}));
});

function printProtocol() {
  window.print();
}

// ESC Key Listener (Closes drawer or details panel safely)
document.addEventListener("keydown", (e)=>{
  if(e.key !== "Escape") return;
  
  const tag = (document.activeElement?.tagName || "").toLowerCase();
  const isTyping = ["input","select","textarea"].includes(tag);

  const drawer = document.getElementById("patientDrawer");
  if(drawer && drawer.classList.contains("open")) {
    closePatients();
    return;
  }

  if(!isTyping){
    const details = document.getElementById("details");
    if(details && details.style.display === "block") collapseDetails();
  }
});

// Update Decision Badge Helper
function updateDecisionBadgeFromSelect(){
  const tri = document.getElementById("triageSelect")?.value || "Routine";
  const dec = decisionFromTriage(tri);
  const badge = document.getElementById("decisionBadge");
  if(!badge) return;
  badge.textContent = dec.badge;
  badge.style.color =
    dec.badge.includes("URGENT") ? "red" :
    dec.badge.includes("SOON") ? "#eab308" : "green";
}

// --- INITIALIZATION ---
async function loadData(){
  try {
    const res = await fetch('./diagnoses.json?v=3');
    allDiagnoses = await res.json();
    buildCategoryFilters();
    applyFilters();
  } catch(e) {
    console.error("Failed to load diagnoses.json", e);
  }
}

// --- DOMAIN & UI FILTERING ---
function setDomain(dom) {
  activeDomain = dom;
  activeCategory = "All"; 
  document.querySelectorAll('.dTab').forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent === dom || (btn.textContent === 'All Domains' && dom === 'All')) {
      btn.classList.add('active');
    }
  });
  buildCategoryFilters();
  applyFilters();
}

function buildCategoryFilters(){
  const bar = document.getElementById("categoryFilters");
  bar.innerHTML = "";
  let validData = allDiagnoses;
  if (activeDomain !== "All") { validData = validData.filter(d => d.domain === activeDomain); }
  const set = new Set(validData.map(d => getCategory(d)));
  const cats = ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
  cats.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "filterBtn" + (cat === activeCategory ? " active" : "");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCategory = cat;
      document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      applyFilters();
    };
    bar.appendChild(b);
  });
}

function clearSearch(){
  const s = document.getElementById("search");
  if(s) s.value = "";
  applyFilters();
}

// --- SMART SEARCH ALGORITHM ---
function norm(s){
  return (s || "").toString().toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
}

function searchKey(dx){
  const parts = [ dx.id, dx.name, dx.domain, dx.category, ...(dx.aliases || []), ...(dx.ddx || []) ];
  return norm(parts.filter(Boolean).join(" "));
}

function scoreMatch(query, key){
  if (!query) return 0;
  if (key.includes(query)) return 100;
  const qTokens = query.split(" ");
  let score = 0;
  for (const t of qTokens){
    if (!t) continue;
    if (key.includes(t)) score += 20;
  }
  return score;
}

function smartFilter(data, q){
  const query = norm(q);
  if (!query) return data;
  const scored = data.map(dx => {
    const key = searchKey(dx);
    const aliasExact = (dx.aliases || []).some(a => norm(a) === query) ? 50 : 0;
    const idExact = norm(dx.id) === query ? 60 : 0;
    const nameExact = norm(dx.name) === query ? 60 : 0;
    const base = scoreMatch(query, key);
    return { dx, score: base + aliasExact + idExact + nameExact };
  });
  return scored.filter(x => x.score > 0).sort((a,b) => b.score - a.score).map(x => x.dx);
}

// --- CORE RENDERING ---
function applyFilters(){
  const raw = (document.getElementById("search").value || "");
  const term = raw.trim();
  let data = allDiagnoses.slice();

  if(activeDomain !== "All") { data = data.filter(d => d.domain === activeDomain); }
  if(activeCategory !== "All"){ data = data.filter(d => getCategory(d) === activeCategory); }
  if(term){ data = smartFilter(data, term); }
  
  renderTiles(data, term);
  updateMeta(data.length, term);
}

function updateMeta(count, term){
  const meta = document.getElementById("metaLine");
  let parts = [`<b>${count}</b> protocols`];
  if(activeDomain !== "All") parts.push(`Domain: <b>${activeDomain}</b>`);
  if(activeCategory !== "All") parts.push(`Category: <b>${activeCategory}</b>`);
  if(term) parts.push(`Search: <b>${term}</b>`);
  meta.innerHTML = parts.join(" â€¢ ");
}

function renderTiles(data, term){
  const t = document.getElementById("tiles");
  t.innerHTML = "";
  if(!data.length){ t.innerHTML = "<div style='color:rgba(255,255,255,.85)'>No matching protocols found.</div>"; return; }
  data.forEach(dx=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    
    // Guard against accidental clicks when selecting text
    tile.onmousedown = (e)=>{ tile._downSel = _hasSelection(); };
    tile.onclick = ()=>{ 
      if(tile._downSel || _hasSelection()) return;
      showDetails(dx);
    };
    
    const octN = listify(dx.oct).length;
    const tarN = listify(dx.targets).length;
    const displayName = highlightTerm(dx.name || dx.id || "Untitled", term);
    tile.innerHTML = `
      <div class="tileTitle">${displayName}</div>
      <div class="catPill">${dx.domain} â€¢ ${getCategory(dx)}</div>
      <div class="countRow"><span>ðŸ“· OCT: ${octN}</span><span>ðŸŽ¯ Targets: ${tarN}</span></div>
    `;
    t.appendChild(tile);
  });
}

function fill(id, arr){
  const ul = document.getElementById(id);
  ul.innerHTML = "";
  (listify(arr) || []).forEach(v=>{
    const li = document.createElement("li");
    li.textContent = v;
    ul.appendChild(li);
  });
}
function setCount(id, n){ document.getElementById(id).textContent = n ? `(${n})` : ""; }

function showDetails(dx){
  const newKey = (dx?.name || dx?.id || "");
  const oldKey = (currentDx?.name || currentDx?.id || "");
  if(newKey && oldKey && newKey !== oldKey) triageWasManuallySet = false;

  currentDx = dx;
  const panel = document.getElementById("details");
  panel.style.display = "block";
  document.getElementById("dxName").textContent = dx.name || dx.id || "";
  
  const o = listify(dx.oct); const a = listify(dx.octa); const t = listify(dx.targets); const f = listify(dx.red_flags);
  fill("octList", o); fill("octaList", a); fill("targetsList", t); fill("flagsList", f);
  setCount("octCount", o.length); setCount("octaCount", a.length); setCount("tCount", t.length); setCount("fCount", f.length);

  const ctx = _ctxFromForm();
  
  const triSel = document.getElementById("triageSelect");
  let tri;
  if(triageWasManuallySet){
    tri = triSel?.value || "Routine";
  } else {
    tri = defaultTriageFor(dx, ctx);
    if(triSel) triSel.value = tri;
  }
  updateDecisionBadgeFromSelect();

  renderDDX(dx);
  
  // Populate print-only patient context header
  const pLine = document.getElementById("printPatientLine");
  if(pLine){
    const pid = (document.getElementById("p_id")?.value || "").trim();
    const eye = (document.getElementById("p_eye")?.value || "").trim();
    const va  = (document.getElementById("p_va")?.value || "").trim();
    const iop = (document.getElementById("p_iop")?.value || "").trim();
    
    const bits = [];
    if(pid) bits.push(`Patient: ${pid}`);
    if(eye) bits.push(`Eye: ${eye}`);
    if(va)  bits.push(`VA: ${va}`);
    if(iop) bits.push(`IOP: ${iop}`);
    
    const txt = bits.join("  |  ");
    pLine.textContent = txt;
    
    const has = !!txt;
    pLine.style.opacity = has ? "1" : "0";
    pLine.style.height = has ? "auto" : "0";
    pLine.style.margin = has ? "6px 0 10px 0" : "0";
    pLine.style.paddingBottom = has ? "8px" : "0";
    pLine.style.borderBottom = has ? "1px dashed #ccc" : "none";
  }

  if (window.matchMedia("(max-width: 920px)").matches) { panel.scrollIntoView({behavior:"smooth", block:"start"}); }
}

function collapseDetails(){
  document.getElementById("details").style.display = "none";
  currentDx = null;
  triageWasManuallySet = false;
}

// --- DDX RULES & CLINICAL CONTEXT ---
function getFindingsState(){
  const wrap = document.getElementById("findingsWrap") || document;
  const state = {};
  wrap.querySelectorAll("input[type=checkbox][data-finding]").forEach(cb=>{ state[cb.dataset.finding] = !!cb.checked; });
  return state;
}

function defaultTriageFor(dx, ctx){
  const t = (listify(dx?.red_flags).join(" ") + " " + listify(dx?.targets).join(" ")).toLowerCase();
  if (ctx?.pain) return "Urgent";
  if (/nv|neovascular|nve|nvd|ischemi|detachment|tear|endophthal|papilledema|crao|crvo|severe/.test(t)) return "Urgent";
  if (/rvo|cnv|wet|edema|dme|pre-?pdr|pdr|widespread|dropout|non[- ]perfusion/.test(t)) return "Soon";
  return "Routine";
}

function decisionFromTriage(level){
  if(level==="Urgent") return {badge:"URGENT REFER"};
  if(level==="Soon") return {badge:"TREAT / REFER SOON"};
  return {badge:"OBSERVE / ROUTINE"};
}

function evalCond(cond, ctx){
  if (!cond) return true;
  if (cond.flag){
    const v = !!ctx?.[cond.flag] || !!ctx?.find?.[cond.flag];
    return ("is" in cond) ? (v === !!cond.is) : v;
  }
  return false;
}

function computeDDX(primaryDx, ctx){
  const all = allDiagnoses.map(d=>d.name);
  const out = [];
  const push = (name, reason, w=0)=>{
    if (!all.includes(name) || name===primaryDx.name) return;
    const ex = out.find(x=>x.name===name);
    if (ex) { ex.w = Math.max(ex.w||0, w||0); return; }
    out.push({name, reason, w});
  };

  if (Array.isArray(primaryDx.ddx_rules)) {
    primaryDx.ddx_rules.forEach(rule=>{
      try { if (evalCond(rule.when, ctx)) push(rule.candidate, rule.reason, rule.weight || 1); } catch(e){}
    });
  }
  if (Array.isArray(primaryDx.ddx)) { primaryDx.ddx.forEach(n=>push(n, "Listed DDx", 2)); }
  
  const n = (primaryDx.name||"").toLowerCase();
  if (n.includes("npdr")) {
    push("Diabetic Macular Edema (DME)", "Rule out coexisting DME", ctx.dm?6:3);
    push("Branch Retinal Vein Occlusion (BRVO)", "Hemorrhage mimic", ctx.htn?4:1);
  }
  
  out.sort((a,b)=> (b.w||0)-(a.w||0));
  return out.slice(0, 6);
}

function renderDDX(primaryDx){
  const wrap = document.getElementById("ddxChips");
  if (!wrap) return;
  wrap.innerHTML = "";
  const ctx = _ctxFromForm();
  const ddx = computeDDX(primaryDx, ctx);

  if (!ddx.length) { wrap.innerHTML = '<span class="hint">No automatic DDx generated.</span>'; return; }
  ddx.forEach(x=>{
    const b = document.createElement("div");
    b.className = "ddx-chip";
    b.textContent = x.name;
    b.title = x.reason || "Open protocol";
    b.onclick = ()=>{ 
      const dx = allDiagnoses.find(d=>d.name===x.name);
      if (dx) showDetails(dx); 
    };
    wrap.appendChild(b);
  });
}

// --- PATIENT STATE & TIMELINE (Local-only) ---
function _loadStore(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '{"patients":{}}'); } catch(e){ return {"patients":{}}; } }
function _saveStore(store){ localStorage.setItem(LS_KEY, JSON.stringify(store)); }
function _nowISO(){ return new Date().toISOString(); }

function _ctxFromForm(){
  const symptoms = (document.getElementById("p_symptoms")?.value || "").toLowerCase();
  const dm = !!document.getElementById("p_dm")?.checked;
  const htn = !!document.getElementById("p_htn")?.checked;
  
  const find = getFindingsState();
  
  find.diabetes = dm;
  find.htn = htn;
  find.hypertension = htn;
  find.dm = dm;

  return {
    dm,
    htn,
    sudden: /sudden|today|yesterday|since morning/.test(symptoms),
    pain: /pain|ache|headache/.test(symptoms),
    symptoms: symptoms,
    find
  };
}

function _getPatientForm(){
  const flags = {
    dm: !!document.getElementById("p_dm")?.checked,
    htn: !!document.getElementById("p_htn")?.checked,
    myopia: !!document.getElementById("p_myopia")?.checked,
    steroid: !!document.getElementById("p_steroid")?.checked,
    smoke: !!document.getElementById("p_smoke")?.checked,
    ...getFindingsState()
  };
  return {
    id: (document.getElementById("p_id")?.value || "").trim(),
    age: (document.getElementById("p_age")?.value || "").trim(),
    sex: (document.getElementById("p_sex")?.value || "").trim(),
    eye: (document.getElementById("p_eye")?.value || "OD").trim(),
    va: (document.getElementById("p_va")?.value || "").trim(),
    iop: (document.getElementById("p_iop")?.value || "").trim(),
    note: (document.getElementById("p_note")?.value || "").trim(),
    symptoms: (document.getElementById("p_symptoms")?.value || "").trim(),
    flags
  };
}

function openPatients(fromDx=false){
  if(fromDx && !currentDx) fromDx = false;
  autoSaveVisitOnPatientSave = !!fromDx;
  
  document.getElementById("drawerOverlay").classList.add("open");
  document.getElementById("patientDrawer").classList.add("open");
  renderPatientList();
  
  const last = localStorage.getItem(LS_KEY + "_last");
  if(last){
    const store = _loadStore();
    if(store.patients && store.patients[last]) loadPatient(last);
  }
  
  const hint = document.getElementById("activeDxHint");
  if (fromDx && currentDx){
    hint.style.display="block";
    hint.textContent = `Ready to link to: ${currentDx.name || currentDx.id}`;
  } else {
    hint.style.display="none";
  }
}

function closePatients(ev){
  if(ev && ev.target && ev.target.id !== "drawerOverlay") return;
  document.getElementById("drawerOverlay").classList.remove("open");
  document.getElementById("patientDrawer").classList.remove("open");
}

function clearPatientForm(){
  document.querySelectorAll(".drawer-body input, .drawer-body select").forEach(el => {
    if(el.type === 'checkbox') el.checked = false;
    else el.value = "";
  });
  document.getElementById("p_eye").value = "OD";
  document.getElementById("visitTimelinePanel").style.display = "none";
  if(currentDx) showDetails(currentDx);
}

function savePatientAndMaybeVisit(){
  const form = _getPatientForm();
  if(!form.id){ alert("Please enter Patient ID / OPD No."); return; }

  const store = _loadStore();
  store.patients = store.patients || {};

  const existing = store.patients[form.id] || { id: form.id, createdAt: _nowISO(), visits: [] };

  existing.age = form.age;
  existing.sex = form.sex;
  existing.eye = form.eye;
  existing.va = form.va;
  existing.iop = form.iop;
  existing.note = form.note;
  existing.symptoms = form.symptoms;
  existing.flags = form.flags;
  existing.updatedAt = _nowISO();

  let loggedThisTime = false;

  if (autoSaveVisitOnPatientSave && currentDx){
    const triage = document.getElementById("triageSelect")?.value || "Routine";
    const dxKey = currentDx.name || currentDx.id || "â€”";
    
    const lastVisit = (existing.visits || [])[0];
    const lastT = lastVisit && lastVisit.at ? new Date(lastVisit.at).getTime() : NaN;
    const tooSoon = lastVisit && lastVisit.dx === dxKey && isFinite(lastT) && (Date.now() - lastT) < 2*60*1000;

    if (!tooSoon) {
      existing.visits.unshift({
        at: _nowISO(),
        dx: dxKey,
        domain: currentDx.domain || "â€”",
        category: getCategory(currentDx),
        triage,
        decision: decisionFromTriage(triage).badge,
        eye: form.eye,
        va: form.va,
        iop: form.iop,
        note: form.note
      });
      existing.visits = existing.visits.slice(0, 30);
      loggedThisTime = true;
    }
    
    autoSaveVisitOnPatientSave = false;
  }

  store.patients[form.id] = existing;
  _saveStore(store);

  const hint = document.getElementById("activeDxHint");
  hint.style.display = "block";
  hint.textContent = loggedThisTime 
    ? `Saved + Visit logged for: ${currentDx.name || currentDx.id}` 
    : "Patient context saved.";

  renderPatientList();
  renderVisitTimeline(existing);
  document.getElementById("visitTimelinePanel")?.scrollIntoView({behavior:"smooth", block:"start"});
}

function renderPatientList(){
  const store = _loadStore();
  const list = document.getElementById("patientList");
  if(!list) return;

  const q = (document.getElementById("patientSearch")?.value || "").trim().toLowerCase();
  const patients = store.patients || {};
  let ids = Object.keys(patients);

  if(q) ids = ids.filter(id => id.toLowerCase().includes(q));

  if(ids.length===0){
    list.innerHTML = `<div style="color:#94a3b8; font-size:12px; padding:6px;">No patients found.</div>`;
    return;
  }

  ids.sort((a,b)=>{
    const A = patients[a]?.updatedAt || patients[a]?.createdAt || "";
    const B = patients[b]?.updatedAt || patients[b]?.createdAt || "";
    return (B > A) ? 1 : (B < A ? -1 : 0);
  });

  list.innerHTML = "";
  ids.forEach(pid=>{
    const p = patients[pid];
    const vCount = (p.visits || []).length;
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="flex:1; min-width:0;">
        <strong>${escapeHtml(pid)}</strong>
        <div style="margin-top:4px;">
          <small>${escapeHtml([p.age?`Age ${p.age}`:"", p.sex||""].filter(Boolean).join(" â€¢ ") || "â€”")}</small>
          <small style="display:block; margin-top:2px;">Visits: ${vCount} â€¢ Updated: ${escapeHtml((p.updatedAt||p.createdAt||"").slice(0,19).replace("T"," "))}</small>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button type="button" class="loadBtn" style="background:#2563eb; color:#fff;" data-pid="${escapeAttr(pid)}">Load</button>
        <button type="button" class="delBtn" style="background:#ef4444; color:#fff;" data-pid="${escapeAttr(pid)}">Delete</button>
      </div>
    `;
    
    el.querySelector(".loadBtn").addEventListener("click", (e)=> loadPatient(e.currentTarget.dataset.pid));
    el.querySelector(".delBtn").addEventListener("click", (e)=> deletePatient(e.currentTarget.dataset.pid));
    
    list.appendChild(el);
  });
}

function loadPatient(pid){
  const store = _loadStore();
  const p = store.patients?.[pid];
  if(!p) return;

  document.getElementById("p_id").value = p.id || pid;
  document.getElementById("p_age").value = p.age || "";
  document.getElementById("p_sex").value = p.sex || "";
  document.getElementById("p_eye").value = p.eye || "OD";
  document.getElementById("p_va").value = p.va || "";
  document.getElementById("p_iop").value = p.iop || "";
  document.getElementById("p_note").value = p.note || "";
  document.getElementById("p_symptoms").value = p.symptoms || "";

  const flags = p.flags || {};
  const map = { dm:"p_dm", htn:"p_htn", myopia:"p_myopia", steroid:"p_steroid", smoke:"p_smoke" };
  Object.keys(map).forEach(k=>{
    const el = document.getElementById(map[k]);
    if(el) el.checked = !!flags[k];
  });

  const wrap = document.getElementById("findingsWrap") || document;
  wrap.querySelectorAll("input[type=checkbox][data-finding]").forEach(cb=>{
    cb.checked = !!flags[cb.dataset.finding];
  });

  renderVisitTimeline(p);

  if(currentDx) showDetails(currentDx);
  
  localStorage.setItem(LS_KEY + "_last", pid);
  document.getElementById("p_symptoms")?.focus();
}

function deletePatient(pid){
  if(!confirm(`Delete patient "${pid}" from this browser?`)) return;
  const store = _loadStore();
  if(store.patients && store.patients[pid]){
    delete store.patients[pid];
    _saveStore(store);
    clearPatientForm();
    renderPatientList();
    
    const last = localStorage.getItem(LS_KEY + "_last");
    if(last === pid) localStorage.removeItem(LS_KEY + "_last");
  }
}

function renderVisitTimeline(p) {
  const panel = document.getElementById("visitTimelinePanel");
  const list = document.getElementById("visitTimelineList");
  
  if(!p || !p.visits || !p.visits.length) {
    panel.style.display = "none";
    return;
  }
  
  panel.style.display = "block";
  list.innerHTML = "";
  
  (p.visits || []).slice(0, 10).forEach(v => {
    const el = document.createElement("div");
    el.className = "item";
    
    let badgeColor = "rgba(255,255,255,0.1)";
    if(v.triage === "Urgent") badgeColor = "rgba(220, 38, 38, 0.2)"; 
    if(v.triage === "Soon") badgeColor = "rgba(202, 138, 4, 0.2)"; 

    const d = new Date(v.at);
    const ds = isNaN(d) ? String(v.at||"").slice(0,10) : d.toLocaleDateString();

    let metrics = [];
    if(v.eye) metrics.push(v.eye);
    if(v.va) metrics.push(`VA: ${v.va}`);
    if(v.iop) metrics.push(`IOP: ${v.iop}`);
    
    const metricStr = metrics.length ? `<div style="margin-top:4px; font-size:11px; color:#cbd5e1;">${escapeHtml(metrics.join(" | "))}</div>` : "";
    const noteStr = v.note ? `<div style="margin-top:2px; font-size:11px; color:#94a3b8; font-style:italic;">"${escapeHtml(v.note)}"</div>` : "";

    el.innerHTML = `
      <div style="flex:1;">
        <strong style="color:#e2e8f0;">${escapeHtml(v.dx)}</strong> 
        <span style="font-size:10px; padding:2px 6px; border-radius:4px; background:${badgeColor}; margin-left:6px;">${escapeHtml(v.triage)}</span>
        ${metricStr}
        ${noteStr}
        <div style="margin-top:4px; font-size:10px; color:#64748b;">Recorded: ${escapeHtml(ds)}</div>
      </div>
      <button type="button" class="reopenBtn" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2);" data-dx="${escapeAttr(v.dx)}">Reopen</button>
    `;
    
    el.querySelector(".reopenBtn").addEventListener("click", (e)=> reopenDx(e.currentTarget.dataset.dx));
    
    list.appendChild(el);
  });
}

function reopenDx(key) {
  const k = (key || "").trim();
  const dx = allDiagnoses.find(d => d.name === k || d.id === k);
  if(dx) {
    closePatients();
    showDetails(dx);
  } else {
    alert("Protocol not found in current database.");
  }
}

// --- EXPORT & IMPORT BACKUPS ---
function exportPatients(){
  const store = _loadStore();
  const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `oct_patients_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

function importPatients(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const f = inp.files?.[0];
    if(!f) return;
    try{
      const text = await f.text();
      const data = JSON.parse(text);
      if(!data || typeof data !== "object" || !data.patients) throw new Error("Invalid file");
      
      const current = _loadStore();
      current.patients = current.patients || {};
      const incoming = data.patients || {};
      Object.keys(incoming).forEach(id=>{
        current.patients[id] = incoming[id];
      });
      _saveStore(current);
      
      renderPatientList();
      alert("Import successful (merged with existing).");
    } catch(e){
      alert("Import failed: invalid backup file.");
    }
  };
  inp.click();
}

// Ensure decision recalculates when fields change
document.addEventListener("DOMContentLoaded", ()=>{ 
  updateDecisionBadgeFromSelect();
  loadData(); 
  document.querySelectorAll(".drawer-body input, .drawer-body select").forEach(el=>{
    el.addEventListener("change", () => {
      if(currentDx) showDetails(currentDx);
    });
  });
  
  // Triage manual override listener
  document.getElementById("triageSelect")?.addEventListener("change", ()=>{
    triageWasManuallySet = true;
    updateDecisionBadgeFromSelect();
  });
});
</script>
</body>
</html>