<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OCT Protocol Dashboard ‚Äì Ratan Kalita</title>

<style>
.ddx-chip{ border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); padding:4px 10px; border-radius:999px; font-size:11px; cursor:pointer; user-select:none; transition:.15s; color:#93c5fd; font-weight:700;}
.ddx-chip:hover{ background:rgba(255,255,255,.10); }
:root{ --bg:#0b1020; --card:#ffffff; --muted:#6b7280; --border:#e5e7eb; --shadow:0 8px 24px rgba(0,0,0,.12); --accent:#1d4ed8; --accent2:#06b6d4; --danger:#dc2626; }
body{ font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; background: radial-gradient(900px 500px at 20% 0%, rgba(29,78,216,0.12), transparent 60%), radial-gradient(900px 500px at 90% 5%, rgba(6,182,212,0.10), transparent 60%), var(--bg); margin:12px 16px; color:#111; }
.wrap{max-width:1220px;margin:auto;}

/* SECURE LOGIN OVERLAY CSS */
#loginOverlay { position:fixed; inset:0; background:#0f172a; z-index:100000; display:flex; align-items:center; justify-content:center; flex-direction:column; padding:20px; }
.login-box { background:#1e293b; border:1px solid #334155; border-radius:12px; max-width:380px; width:100%; padding:30px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); text-align:center;}
.login-box h2 { margin:0 0 6px 0; color:#fff; font-size:22px; font-weight:900; letter-spacing:0.5px;}
.login-box p { color:#94a3b8; font-size:13px; margin:0 0 24px 0;}
.l-input { width:100%; padding:14px; margin-bottom:14px; border-radius:8px; border:1px solid #475569; background:#0f172a; color:#fff; font-size:14px; outline:none; box-sizing:border-box; transition:0.2s;}
.l-input:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.2);}
.l-btn { width:100%; padding:14px; border-radius:8px; background:#2563eb; color:#fff; font-weight:bold; font-size:15px; border:none; cursor:pointer; transition:0.2s; margin-top:8px;}
.l-btn:hover { background:#1d4ed8; }
.l-error { color:#fca5a5; font-size:13px; margin-bottom:16px; font-weight:600; min-height:18px; }

/* ULTRA-COMPACT HEADER */
header{ background:linear-gradient(135deg,#1d4ed8,#06b6d4); color:white; padding:12px 16px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.20); position: sticky; top: 10px; z-index: 4; display:flex; flex-direction:column; gap:10px;}
.h-top { display:flex; justify-content:space-between; align-items:center; }
.h-title h1 { margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; display:inline-block; }
.sub { font-size:12px; opacity:.85; display:inline-block; margin-left:8px; font-weight:500; border-left:1px solid rgba(255,255,255,0.3); padding-left:8px;}

.h-mid { display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; }
.domain-tabs { display:flex; gap:6px; overflow-x:auto; flex:1; }
.dTab { background:transparent; border:none; color:rgba(255,255,255,.65); font-weight:800; font-size:13px; cursor:pointer; padding:4px 10px; transition:.2s; white-space:nowrap; }
.dTab:hover { color:rgba(255,255,255,.9); }
.dTab.active { color:#fff; background:rgba(255,255,255,.2); border-radius:6px; }

.searchWrap{ flex:0 1 320px; min-width:200px; position:relative; }
#search{ width:100%; padding:6px 28px 6px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.16); color:#fff; font-size:13px; outline:none; box-sizing:border-box;}
#search::placeholder{color:rgba(255,255,255,.70)}
.clearX{ position:absolute; right:6px; top:50%; transform:translateY(-50%); width:20px;height:20px; border-radius:6px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.12); color:#fff; cursor:pointer; display:flex;align-items:center;justify-content:center; font-weight:900; font-size:12px;}
.clearX:hover{filter:brightness(1.12)}

.btn{ padding:6px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35); background:rgba(0,0,0,0.2); color:#fff; font-weight:800; cursor:pointer; font-size:12px;}
.btn:hover{filter:brightness(1.20)}

.h-bot { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;}
.filterBar{ display:flex; flex-wrap:wrap; gap:4px; flex:1;}
.filterBtn{ padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.30); background:rgba(255,255,255,.10); color:rgba(255,255,255,0.9); font-weight:700; cursor:pointer; font-size:11px; }
.filterBtn.active{ background:white; color:#1d4ed8; box-shadow:0 4px 10px rgba(0,0,0,.15); font-weight:800;}
.metaLine{ font-size:11px; opacity:.90; font-weight:600; text-align:right;}

/* REBALANCED & COMPACT LAYOUT */
.main{ display:grid; grid-template-columns: 0.85fr 1.3fr; gap:16px; margin-top:14px; align-items:start; }
.grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap:10px; }

.tile{ background:var(--card); border:1px solid var(--border); padding:10px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,.05); cursor:pointer; transition:.12s; }
.tile:hover{ transform:translateY(-2px); box-shadow:0 8px 16px rgba(29,78,216,.10); border-color: rgba(29,78,216,.3); }
.tileTitle{font-weight:800;font-size:13px;line-height:1.2; color:#0f172a;}
.catPill{ display:inline-flex; margin-top:6px; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:700; color:#475569; background:#f1f5f9; border:1px solid #e2e8f0;}
.countRow{ margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; font-size:10px; color:#64748b; font-weight:700; }
.countRow span{ display:inline-flex; gap:4px; align-items:center; padding:2px 6px; border-radius:4px; background:#f8fafc; border:1px solid #e2e8f0; }

.panel{ background:var(--card); border:1px solid var(--border); border-left:6px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px 20px; position: sticky; top: 110px; display:none; transition: border-left-color 0.3s; }
.panel h2{margin:0 0 6px 0;color:var(--accent); font-size:18px;}
.panel h3{ margin:14px 0 6px 0; border-bottom:1px solid #f1f5f9; padding-bottom:4px; color:#334155; display:flex; justify-content:space-between; align-items:center; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; font-weight:800;}

/* OBSERVATION CHIP STYLES */
.obsChip{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:6px; border:1px solid #cbd5e1; background:#f8fafc; font-size:11px; font-weight:700; cursor:pointer; user-select:none; line-height:1.3; transition:0.15s; color:#334155;}
.obsChip:hover{ background:#f1f5f9; border-color:#94a3b8; }
.obsChip.on{ background:#dcfce7; border-color:#22c55e; color:#166534; box-shadow:0 2px 6px rgba(34,197,94,0.15); }
.obsChip.flag{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
.obsChip.flag:hover{ background:#fee2e2; border-color:#fca5a5; }
.obsChip.flag.on{ background:#fee2e2; border-color:#ef4444; color:#991b1b; box-shadow:0 2px 6px rgba(239,68,68,0.15); }

.actionRow{ display:flex; gap:6px; flex-wrap:wrap; }
.pBtn{ padding:4px 10px; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:800; font-size:11px; color:#475569;}
.pBtn:hover{border-color: rgba(29,78,216,.35); background:#f8fafc; color:#1d4ed8; }
@media (max-width: 920px){ .main{grid-template-columns:1fr;} .panel{position:relative; top:auto;} .h-title h1 {display:block;} .sub {display:block; margin:2px 0 0 0; border:none; padding:0;} }
.footer{ text-align:center; margin:20px 0; color:rgba(255,255,255,.40); font-size:10px; line-height: 1.5; }

/* DRAWER CSS */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:.2s;z-index:60}
.drawer-overlay.open{opacity:1;pointer-events:auto}
.drawer{position:fixed;top:0;right:-400px;width:400px;max-width:90vw;height:100vh;background:#0f172a;border-left:1px solid rgba(148,163,184,.2);z-index:70;transition:.25s;display:flex;flex-direction:column; color:white;}
.drawer.open{right:0}
.drawer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.15);background:linear-gradient(180deg, rgba(59,130,246,.12), rgba(139,92,246,.06))}
.drawer-body{padding:14px;overflow:auto;display:flex;flex-direction:column;gap:12px}
.d-panel{background:rgba(51,65,85,.55);border:1px solid rgba(148,163,184,.12);border-radius:10px;padding:12px}
.panel-title{font-size:11px;color:#94a3b8;margin-bottom:8px;letter-spacing:.02em;text-transform:uppercase; font-weight:800;}
.row{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.row label{font-size:11px;color:#94a3b8; font-weight:600;}
.row input,.row select{background:rgba(15,23,42,.6);border:1px solid rgba(148,163,184,.18);color:#fff;border-radius:6px;padding:6px 8px;outline:none; font-size:12px;}
.row input:focus,.row select:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 8px}
.chk{display:flex;align-items:center;gap:6px;font-size:11px;color:#fff;background:rgba(15,23,42,.35);padding:4px 8px;border-radius:6px;border:1px solid rgba(148,163,184,.12); cursor:pointer; user-select:none;}
.actions{display:flex;gap:8px;justify-content:flex-end; margin-top:4px;}
.list{display:flex;flex-direction:column;gap:6px}
.item{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:8px;padding:8px 10px}
.item strong{color:white;font-size:12px}
.item small{color:#94a3b8;font-size:11px}
.item button{padding:4px 8px;font-size:11px; border-radius:4px; border:none; cursor:pointer;}
.hint{margin-top:6px;color:#94a3b8;font-size:11px}
.close-btn{background:transparent; border:none; color:white; font-size:22px; cursor:pointer; padding:0; line-height:1;}

/* COPYRIGHT MODAL CSS */
#startupModal { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; display:none; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px); }
.modal-box { background:#0f172a; border:1px solid #334155; border-radius:12px; max-width:450px; padding:24px; color:#f8fafc; box-shadow:0 20px 40px rgba(0,0,0,0.5); text-align:center; }
.modal-box h2 { margin:0 0 12px 0; color:#38bdf8; font-size:18px; text-transform:uppercase; letter-spacing:0.5px;}
.modal-box p { font-size:13px; line-height:1.6; color:#cbd5e1; margin-bottom:20px; text-align:left;}

/* PRINT STYLES */
#reportPrint { display:none; }
@media print {
  body { background:#fff !important; color:#000 !important; margin:0 !important; }
  header, .filterBar, .toolsRow, .metaLine, .domain-tabs, .drawer, .drawer-overlay, .footer, #startupModal, #loginOverlay { display:none !important; }
  .main { display:block !important; margin:0 !important; }
  #tiles { display:none !important; }
  #details { display:none !important; }
  #reportPrint { display:block !important; }
}
</style>
</head>

<body>

<script type="module">
  // 1. Import the Supabase Engine
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // 2. Your Supabase Keys
  const SUPABASE_URL = 'https://sesxtccsrykoomcrtoyr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlc3h0Y2Nzcnlrb29tY3J0b3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNTEwMjEsImV4cCI6MjA4NzgyNzAyMX0.RJJRloNnUjb8KsPavkJ1fukzuV0NwZlyOg8iQ5Xcg5I';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginErr = document.getElementById("loginError");

  // 3. The Secure Fetch Protocol 
  window.loadData = async function(){
    try {
        // Reaches into the private vault. Fails if the user is not authenticated.
        const { data, error } = await supabase.storage.from('clinical_vault').download('diagnoses.json');
        if (error) throw error;
        
        const text = await data.text();
        window.allDiagnoses = JSON.parse(text);
        
        // Trigger the UI to build
        if (typeof buildCategoryFilters === "function") buildCategoryFilters();
        if (typeof applyFilters === "function") applyFilters();
    } catch(e) { 
        console.error("Vault access denied.", e); 
        alert("Secure data fetch failed. Your access may be revoked. Contact Ratan.");
    }
  }

  // 4. The Login Strike
  loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPassword").value;
      loginErr.textContent = "Authenticating with server...";
      
      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) loginErr.textContent = "Invalid credentials. You are not authorized.";
  });

  // 5. The Logout Protocol
  logoutBtn.addEventListener("click", async () => { 
      await supabase.auth.signOut(); 
      location.reload(); // Hard reset the app state
  });

  // 6. The Heartbeat (Constantly monitors access)
  supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
          // Logged IN: Drop the wall
          document.getElementById("loginOverlay").style.display = "none";
          document.getElementById("startupModal").style.display = "flex";
          if(window.allDiagnoses && window.allDiagnoses.length === 0) {
              window.loadData();
          }
      } else {
          // Logged OUT: Raise the wall, wipe memory
          document.getElementById("loginOverlay").style.display = "flex";
          document.getElementById("startupModal").style.display = "none";
          document.getElementById("loginPassword").value = "";
          loginErr.textContent = "";
          window.allDiagnoses = []; 
      }
  });
</script>

<div id="loginOverlay">
  <div class="login-box">
    <h2>Secure Gateway</h2>
    <p>Please log in to access the clinical system.</p>
    <div class="l-error" id="loginError"></div>
    <input type="email" id="loginEmail" class="l-input" placeholder="Admin Email" autocapitalize="none" autocorrect="off" spellcheck="false" />
    <input type="password" id="loginPassword" class="l-input" placeholder="Password" autocapitalize="none" autocorrect="off" spellcheck="false" />
    <button class="l-btn" id="loginBtn">Log In</button>
  </div>
</div>

<div id="startupModal">
  <div class="modal-box">
    <h2>‚ö†Ô∏è Copyright & Terms of Use</h2>
    <p>
      <b>¬© 2026 Ratan Kalita. All rights reserved.</b><br><br>
      This software is a <strong>Clinical Decision Support Tool</strong> intended solely for use by qualified eye care professionals. It does not replace independent clinical judgment, diagnosis, or treatment.<br><br>
      By proceeding, you agree to ensure all patient data and images are fully de-identified before entering them into any external or shared system.
    </p>
    <button onclick="document.getElementById('startupModal').style.display='none'" style="width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px; font-weight:800; cursor:pointer; font-size:14px; transition:0.2s;">I Acknowledge & Agree</button>
  </div>
</div>

<div class="wrap">

<header>
  <div class="h-top">
    <div class="h-title">
      <h1>Ratan Kalita</h1>
      <span class="sub">OCT / OCT-A Protocol Dashboard</span>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn" onclick="openPatients()">üë• Patients</button>
      <button class="btn" id="logoutBtn" style="background:rgba(220,38,38,0.15); color:#fca5a5; border-color:rgba(220,38,38,0.3);">üö™ Logout</button>
    </div>
  </div>

  <div class="h-mid">
    <div class="domain-tabs">
      <button class="dTab active" onclick="setDomain('All')">All Domains</button>
      <button class="dTab" onclick="setDomain('Retina')">Retina</button>
      <button class="dTab" onclick="setDomain('Optic Nerve')">Optic Nerve</button>
      <button class="dTab" onclick="setDomain('Anterior Segment')">Anterior Segment</button>
    </div>

    <div class="searchWrap">
      <input id="search" placeholder="Search (e.g., BRVO, DME)..." onkeyup="debouncedSearch()">
      <div class="clearX" title="Clear" onclick="clearSearch()">√ó</div>
    </div>
  </div>

  <div class="h-bot">
    <div class="filterBar" id="categoryFilters"></div>
    <div class="metaLine" id="metaLine"></div>
  </div>
</header>

<div class="main">
  <div>
    <div id="tiles" class="grid"></div>
  </div>

  <div id="details" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
      <div style="flex:1; padding-right:12px;">
        <h2 id="dxName" style="margin:0 0 6px 0;"></h2>
        <div id="activePatientBanner" style="display:none; font-size:11px; color:#475569; background:#f8fafc; padding:4px 8px; border-radius:4px; border:1px solid #e2e8f0; margin-bottom:4px;"></div>
      </div>
      <div class="actionRow">
        <button class="pBtn" type="button" onclick="clearFindings()">üßΩ Clear</button>
        <button class="pBtn" type="button" onclick="copyReport()">üìã Copy</button>
        <button class="pBtn" type="button" onclick="printProtocol()">üñ® Print</button>
        <button class="pBtn" type="button" style="border-color:#1d4ed8; color:#1d4ed8;" onclick="openPatients(true)">üíæ Save</button>
        <button class="pBtn" type="button" onclick="collapseDetails()">‚úñ</button>
      </div>
    </div>
    
    <div id="scanBanner" style="display:none; background:#e0f2fe; border:1px solid #bae6fd; padding:12px 16px; border-radius:8px; margin-bottom:16px;">
      <div style="font-size:11px; font-weight:900; color:#0284c7; text-transform:uppercase; margin-bottom:6px; letter-spacing:0.5px;">üìã Recommended Scan Protocol</div>
      <div id="scanOctTxt" style="font-size:12px; color:#0f172a; font-weight:600; margin-bottom:4px;"></div>
      <div id="scanOctaTxt" style="font-size:12px; color:#0f172a; font-weight:600;"></div>
    </div>

    <h3>üì∑ Structural OCT <span id="octCount" style="font-size:11px; opacity:0.6;"></span></h3>
    <div id="octList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>

    <h3>üß¨ OCT-A Protocol <span id="octaCount" style="font-size:11px; opacity:0.6;"></span></h3>
    <div id="octaList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>

    <h3>üéØ Analysis Targets <span id="tCount" style="font-size:11px; opacity:0.6;"></span></h3>
    <div id="targetsList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>

    <h3>‚ö† Red Flags <span id="fCount" style="font-size:11px; opacity:0.6;"></span></h3>
    <div id="flagsList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>

    <hr style="border:0; border-top:1px solid #e2e8f0; margin:16px 0 12px 0;">

    <div class="d-panel" style="background:#f8fafc; border:1px solid #cbd5e1; padding:12px; border-radius:8px;">
      <div class="row2" style="gap:16px;">
        <div class="row" style="margin:0;">
          <label style="font-weight:800; color:#1d4ed8; font-size:11px; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;">1. Clinical Triage</label>
          <select id="triageSelect" style="color:#000; background:#fff; border-color:#cbd5e1; font-weight:700; cursor:pointer; font-size:13px; padding:6px; border-radius:6px;">
            <option value="Routine">Routine</option>
            <option value="Soon">Refer soon</option>
            <option value="Urgent">Urgent</option>
          </select>
          <div class="hint" style="margin-top:6px; display:flex; align-items:center; gap:6px; color:#475569; font-size:10px;">
            <span style="font-weight:700;">Decision:</span>
            <span id="decisionBadge" style="font-weight:800; padding:2px 6px; border-radius:4px; background:#f1f5f9; cursor:help;">‚Äî</span>
          </div>
        </div>
        <div class="row" style="margin:0;">
          <label style="font-weight:800; color:#1d4ed8; font-size:11px; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;">2. DDx Suggestions</label>
          <div id="ddxChips" style="display:flex; flex-wrap:wrap; gap:4px;"></div>
        </div>
      </div>
      
      <div style="margin-top:12px;">
        <label style="font-weight:800; color:#1d4ed8; font-size:11px; margin-bottom:4px; display:block; text-transform:uppercase; letter-spacing:0.5px;">3. Clinical Impression / Plan</label>
        <textarea id="doctorNotes" placeholder="Type final impression or plan..." style="width:100%; box-sizing:border-box; background:#fff; border:1px solid #cbd5e1; color:#000; border-radius:6px; padding:8px; font-family:inherit; font-size:12px; resize:vertical; min-height:45px;" oninput="document.getElementById('p_note').value = this.value"></textarea>
      </div>
    </div>

  </div>
</div>

<div id="reportPrint"></div>

<div class="footer">
  ‚ö† <strong>Clinical Decision Support Only:</strong> This tool is not a substitute for clinical judgment.<br>
  üì∏ <strong>Data Privacy:</strong> All images and patient names must be fully de-identified before external upload or sharing.<br>
  ¬© Ratan Kalita (Optometry)
</div>

</div>

<div class="drawer-overlay" id="drawerOverlay" onclick="closePatients(event)"></div>
<aside class="drawer" id="patientDrawer" aria-hidden="true">
  <div class="drawer-header">
    <div>
      <div style="font-weight:800; font-size:14px;">Patients</div>
      <div style="font-size:10px; color:#cbd5e1;">Local follow-ups (offline).</div>
    </div>
    <button class="close-btn" onclick="closePatients()">√ó</button>
  </div>

  <div class="drawer-body">
    <div class="d-panel">
      <div class="panel-title">Active Patient Context</div>
      <div class="row">
        <label>Patient ID / OPD No</label>
        <input id="p_id" placeholder="e.g. OPD-1203 / Phone" />
      </div>
      <div class="row2">
        <div class="row">
          <label>Age</label>
          <input id="p_age" inputmode="numeric" placeholder="e.g. 58" />
        </div>
        <div class="row">
          <label>Sex</label>
          <select id="p_sex">
            <option value="">‚Äî</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      
      <div class="row2">
        <div class="row">
          <label style="color:#60a5fa;">VA OD (Right)</label>
          <input id="p_va_od" placeholder="e.g. 6/12" />
        </div>
        <div class="row">
          <label style="color:#60a5fa;">VA OS (Left)</label>
          <input id="p_va_os" placeholder="e.g. 6/12" />
        </div>
      </div>
      <div class="row2">
        <div class="row">
          <label style="color:#34d399;">IOP OD (mmHg)</label>
          <input id="p_iop_od" inputmode="numeric" placeholder="e.g. 18" />
        </div>
        <div class="row">
          <label style="color:#34d399;">IOP OS (mmHg)</label>
          <input id="p_iop_os" inputmode="numeric" placeholder="e.g. 18" />
        </div>
      </div>
      
      <div class="chips" id="findingsWrap">
        <label class="chk"><input type="checkbox" id="p_dm"> Diabetes</label>
        <label class="chk"><input type="checkbox" id="p_htn"> HTN</label>
        <label class="chk"><input type="checkbox" id="p_myopia"> High myopia</label>
        <label class="chk"><input type="checkbox" id="p_steroid"> Steroids</label>
        <label class="chk"><input type="checkbox" id="p_smoke"> Smoker</label>
        <label class="chk" style="border-color: #3b82f6;"><input type="checkbox" data-finding="recent_surgery" id="f_recent_surgery"> Recent Surgery</label>
      </div>

      <div class="row">
        <label>Symptoms / Onset</label>
        <input id="p_symptoms" placeholder="e.g. sudden blur 3 days" />
      </div>
      
      <div class="row">
        <label>Visit Note / Plan</label>
        <input id="p_note" placeholder="Quick clinical note..." oninput="document.getElementById('doctorNotes').value = this.value" />
      </div>
      
      <div class="actions" style="margin-top:6px;">
        <button type="button" style="padding:6px 10px; border-radius:6px; cursor:pointer; background:rgba(255,255,255,0.1); color:#fff; border:none; font-size:11px;" onclick="clearPatientForm()">Clear Form</button>
        <button type="button" style="padding:6px 10px; border-radius:6px; cursor:pointer; background:#2563eb; color:white; border:none; font-weight:700; font-size:11px;" onclick="savePatientAndMaybeVisit()">Save Context</button>
      </div>
      <div id="activeDxHint" class="hint" style="display:none; color:#fbbf24; font-weight:bold; margin-top:8px;"></div>
      <div id="overdueAlert" class="hint" style="display:none; color:#ef4444; font-weight:bold; margin-top:4px;"></div>
    </div>

    <div class="d-panel" id="visitTimelinePanel" style="display:none;">
      <div class="panel-title">Visit Timeline</div>
      <div id="visitTimelineList" class="list"></div>
    </div>

    <div class="d-panel">
      <div class="panel-title">Saved Patients</div>
      <div style="display:flex; gap:6px; margin-bottom:8px;">
        <button type="button" style="flex:1; padding:6px; font-size:10px; border-radius:6px; background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.15); cursor:pointer;" onclick="exportPatients()">Export Data</button>
        <button type="button" style="flex:1; padding:6px; font-size:10px; border-radius:6px; background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.15); cursor:pointer;" onclick="importPatients()">Import Data</button>
      </div>
      <input id="patientSearch" placeholder="Search patient ID..." oninput="renderPatientList()" style="width:100%; box-sizing:border-box; background:rgba(15,23,42,.6); border:1px solid rgba(148,163,184,.18); color:#fff; border-radius:6px; padding:6px 8px; margin-bottom:8px; font-size:11px;" />
      <div id="patientList" class="list"></div>
    </div>
    
  </div>
</aside>

<script>
// Expose functions to the window so the HTML onclick handlers can still find them
window.allDiagnoses = [];
let activeDomain = "All";
let activeCategory = "All";
let currentDx = null;
let triageWasManuallySet = false;
let autoSaveVisitOnPatientSave = false;

let currentObs = { oct:{}, octa:{}, targets:{}, flags:{} };
function _resetObs(){ currentObs = { oct:{}, octa:{}, targets:{}, flags:{} }; }

const LS_KEY = "octengine_patients_v2"; 

(function migrateV1toV2(){
  const v1 = localStorage.getItem("octengine_patients_v1");
  const v2 = localStorage.getItem("octengine_patients_v2");
  if(v1 && !v2){ localStorage.setItem("octengine_patients_v2", v1); }
})();

function getCategory(dx){ return (dx && dx.category) ? dx.category.toString().trim() : "Other"; }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
function listify(v){
  if(Array.isArray(v)) return v.filter(x=>String(x||"").trim().length).map(x=>String(x));
  if(v==null) return [];
  return String(v).split(/\r?\n/).map(x=>x.replace(/^\s*[‚Ä¢\-*]+\s*/,"").trim()).filter(x=>x.length);
}

function _hasSelection(){ const s = window.getSelection?.(); return s && String(s).length > 0; }
function _reEscape(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function highlightTerm(text, term) {
  if(!term) return escapeHtml(text);
  const safeText = escapeHtml(text);
  const tokens = norm(term).split(/\s+/).filter(Boolean).map(_reEscape);
  if(!tokens.length) return safeText;
  const regex = new RegExp(`(${tokens.join('|')})`, 'gi');
  return safeText.replace(regex, `<mark style="background:rgba(29,78,216,0.2); color:#1d4ed8; padding:0 2px; border-radius:3px;">$1</mark>`);
}

document.addEventListener("click", (e)=>{
  const lab = e.target.closest(".chk");
  if(!lab) return;
  const cb = lab.querySelector("input[type=checkbox]");
  if(!cb || cb.disabled) return;
  if(e.target === cb) return;
  cb.checked = !cb.checked;
  cb.dispatchEvent(new Event("change", {bubbles:true}));
});

document.addEventListener("keydown", (e)=>{
  if(e.key !== "Escape") return;
  const tag = (document.activeElement?.tagName || "").toLowerCase();
  const isTyping = ["input","select","textarea"].includes(tag);
  const drawer = document.getElementById("patientDrawer");
  if(drawer && drawer.classList.contains("open")) { closePatients(); return; }
  if(!isTyping){
    const details = document.getElementById("details");
    if(details && details.style.display === "block") collapseDetails();
  }
});

function updateDecisionBadgeFromSelect(){
  const tri = document.getElementById("triageSelect")?.value || "Routine";
  const dec = decisionFromTriage(tri);
  const badge = document.getElementById("decisionBadge");
  const panel = document.getElementById("details");
  
  if(badge) {
    badge.textContent = dec.badge;
    badge.style.color = dec.badge.includes("URGENT") ? "#ef4444" : dec.badge.includes("SOON") ? "#eab308" : "#10b981";
  }
  if (panel) {
      if(tri === "Urgent") panel.style.borderLeftColor = "#ef4444";
      else if(tri === "Soon") panel.style.borderLeftColor = "#eab308";
      else panel.style.borderLeftColor = "#10b981";
  }
}

function computeTriage(dx, ctx, obs) {
  let tri = "Routine";
  let reason = "Baseline monitoring (no high-risk findings selected)";
  let score = 0;
  const scores = { "Routine": 0, "Soon": 1, "Urgent": 2 };

  const setTri = (level, r) => {
    if(scores[level] > score) { tri = level; reason = r; score = scores[level]; }
  };

  if (ctx.pain) setTri("Urgent", "Context: Patient reports pain");
  if (ctx.sudden) setTri("Soon", "Context: Sudden onset symptoms");

  if (Array.isArray(dx.triage_rules) && dx.triage_rules.length > 0) {
    dx.triage_rules.forEach(rule => {
       let match = false;
       if (rule.when) {
         if (rule.when.any_flag_selected) match = Object.values(obs.flags || {}).some(Boolean);
         else if (rule.when.any_target_selected) match = Object.values(obs.targets || {}).some(Boolean);
         else if (rule.when.chip_contains) {
             const bucketName = rule.when.bucket || "targets";
             const bucket = obs[bucketName] || {};
             match = Object.entries(bucket).some(([k,v]) => v && k.includes(norm(rule.when.chip_contains)));
         } else if (rule.when.flag) match = evalCond(rule.when, ctx);
       }
       if (match) setTri(rule.level, rule.reason || `Protocol rule: ${rule.level}`);
    });
  } else {
    const anyFlag = Object.values(obs.flags || {}).some(Boolean);
    if (anyFlag) setTri("Urgent", "Auto fallback: Red flag selected");
    const anyTarget = Object.entries(obs.targets || {}).some(([k,v]) => v && _isSoonTargetKey(k));
    if (anyTarget && score < 1) setTri("Soon", "Auto fallback: High-risk finding selected");
  }
  return { level: tri, reason: reason };
}

function _isSoonTargetKey(key){ return /(fluid|sr?f|irf|edema|dme|cnv|nv|ischemi|dropout|non perfusion|hemorrhage|traction|detachment)/.test(key); }

function autoTriageFromObservations(){
  if(triageWasManuallySet) return;
  const ctx = _ctxFromForm();
  const result = computeTriage(currentDx, ctx, currentObs); 
  const triSel = document.getElementById("triageSelect");
  if(triSel && triSel.value !== result.level) triSel.value = result.level;
  updateDecisionBadgeFromSelect();
  const badge = document.getElementById("decisionBadge");
  if(badge) badge.title = result.reason;
}

function renderChips(containerId, items, bucket, isFlag=false){
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  (items||[]).forEach(text=>{
    const chip = document.createElement("div");
    chip.className = "obsChip" + (isFlag ? " flag" : "");
    chip.textContent = text;
    const key = norm(text); 
    const isOn = !!(currentObs[bucket] && currentObs[bucket][key]);
    chip.classList.toggle("on", isOn);
    chip.onclick = ()=>{
      currentObs[bucket][key] = !currentObs[bucket][key];
      chip.classList.toggle("on", !!currentObs[bucket][key]);
      autoTriageFromObservations();
      renderDDX(currentDx);
    };
    el.appendChild(chip);
  });
}

window.clearFindings = function(){
  _resetObs();
  if(currentDx) {
    const o = listify(currentDx.oct), a = listify(currentDx.octa), t = listify(currentDx.targets), f = listify(currentDx.red_flags);
    renderChips("octList", o, "oct");
    renderChips("octaList", a, "octa");
    renderChips("targetsList", t, "targets");
    renderChips("flagsList", f, "flags", true);
    autoTriageFromObservations();
  }
}

function getReportList(items, bucket) {
    return items.map(x => {
        const key = norm(x);
        const isChecked = !!(currentObs[bucket] && currentObs[bucket][key]);
        return (isChecked ? "‚òë " : "‚òê ") + x;
    });
}

function _copyTextFallback(txt){
  const ta = document.createElement("textarea");
  ta.value = txt; ta.style.position = "fixed"; ta.style.left = "-9999px";
  document.body.appendChild(ta); ta.focus(); ta.select();
  try { document.execCommand("copy"); } catch(e){}
  document.body.removeChild(ta);
}

window.copyReport = function(){
  if(!currentDx){ alert("Open a protocol first."); return; }
  const pid = (document.getElementById("p_id")?.value || "").trim();
  const age = (document.getElementById("p_age")?.value || "").trim();
  const sex = (document.getElementById("p_sex")?.value || "").trim();
  const va_od = (document.getElementById("p_va_od")?.value || "").trim();
  const va_os = (document.getElementById("p_va_os")?.value || "").trim();
  const iop_od = (document.getElementById("p_iop_od")?.value || "").trim();
  const iop_os = (document.getElementById("p_iop_os")?.value || "").trim();
  const sx = (document.getElementById("p_symptoms")?.value || "").trim();
  
  const noteEl = document.getElementById("doctorNotes");
  const note = noteEl ? noteEl.value.trim() : (document.getElementById("p_note")?.value || "").trim();
  const triage = document.getElementById("triageSelect")?.value || "Routine";
  const decision = decisionFromTriage(triage).badge;

  const oct = getReportList(listify(currentDx.oct), 'oct');
  const octa = getReportList(listify(currentDx.octa), 'octa');
  const targets = getReportList(listify(currentDx.targets), 'targets');
  const flags = getReportList(listify(currentDx.red_flags), 'flags');

  const lines = [];
  lines.push(`OCT/OCTA REPORT`);
  lines.push(`Date: ${new Date().toLocaleString()}`);
  if(pid) lines.push(`Patient: ${pid}`);
  if(age || sex) lines.push(`Age/Sex: ${age||"-"} / ${sex||"-"}`);
  if(va_od || va_os) lines.push(`VA (OD/OS): ${va_od||"-"} / ${va_os||"-"}`);
  if(iop_od || iop_os) lines.push(`IOP (OD/OS): ${iop_od||"-"} / ${iop_os||"-"}`);
  if(sx) lines.push(`Symptoms: ${sx}`);
  lines.push(``);
  lines.push(`Provisional Dx: ${currentDx.name || currentDx.id || "-"}`);
  lines.push(`Domain/Category: ${currentDx.domain || "-"} / ${getCategory(currentDx)}`);
  
  if(currentDx.scan_oct || currentDx.scan_octa) {
      lines.push(`Recommended Scans Executed:`);
      if(currentDx.scan_oct) lines.push(`OCT: ${currentDx.scan_oct}`);
      if(currentDx.scan_octa) lines.push(`OCTA: ${currentDx.scan_octa}`);
  }
  
  lines.push(`Triage: ${triage} | Decision: ${decision}`);
  lines.push(``);
  lines.push(`Structural OCT:`);
  oct.forEach(x=>lines.push(`${x}`));
  lines.push(``);
  lines.push(`OCT-A Protocol:`);
  octa.forEach(x=>lines.push(`${x}`));
  lines.push(``);
  lines.push(`Analysis Targets:`);
  targets.forEach(x=>lines.push(`${x}`));
  lines.push(``);
  if(flags.length){
    lines.push(`Red Flags:`);
    flags.forEach(x=>lines.push(`${x}`));
    lines.push(``);
  }
  if(note) { lines.push(`Clinical Impression / Plan:`); lines.push(note); }

  const txt = lines.join("\n");
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(txt).then(()=>alert("Report copied ‚úÖ")).catch(()=>{ _copyTextFallback(txt); alert("Report copied ‚úÖ"); });
  } else { _copyTextFallback(txt); alert("Report copied ‚úÖ"); }
}

window.printProtocol = function(){
  if(!currentDx){ alert("Open a protocol first."); return; }
  const triage = document.getElementById("triageSelect")?.value || "Routine";
  const decision = decisionFromTriage(triage).badge;
  const pid = (document.getElementById("p_id")?.value || "").trim();
  const age = (document.getElementById("p_age")?.value || "").trim();
  const sex = (document.getElementById("p_sex")?.value || "").trim();
  const va_od = (document.getElementById("p_va_od")?.value || "").trim();
  const va_os = (document.getElementById("p_va_os")?.value || "").trim();
  const iop_od = (document.getElementById("p_iop_od")?.value || "").trim();
  const iop_os = (document.getElementById("p_iop_os")?.value || "").trim();
  const sx = (document.getElementById("p_symptoms")?.value || "").trim();
  const noteEl = document.getElementById("doctorNotes");
  const note = noteEl ? noteEl.value.trim() : (document.getElementById("p_note")?.value || "").trim();
  const oct = getReportList(listify(currentDx.oct), 'oct');
  const octa = getReportList(listify(currentDx.octa), 'octa');
  const targets = getReportList(listify(currentDx.targets), 'targets');
  const flags = getReportList(listify(currentDx.red_flags), 'flags');

  const report = document.getElementById("reportPrint");
  report.innerHTML = `
    <div style="font-family:Arial, sans-serif; color:#000; padding:18px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
          <div style="font-size:18px; font-weight:800;">OCT / OCTA Report</div>
          <div style="font-size:12px; margin-top:2px;">Ratan Kalita ‚Ä¢ ${new Date().toLocaleString()}</div>
        </div>
        <div style="font-size:12px; font-weight:800; padding:6px 10px; border:1px solid #ccc; border-radius:6px;">
          ${escapeHtml(triage)} ‚Ä¢ ${escapeHtml(decision)}
        </div>
      </div>
      <div style="margin-top:12px; border-top:1px solid #ddd; padding-top:10px; font-size:12px; line-height:1.5;">
        <b>Patient:</b> ${escapeHtml(pid||"‚Äî")} &nbsp; | &nbsp;
        <b>Age/Sex:</b> ${escapeHtml(age||"‚Äî")}/${escapeHtml(sex||"‚Äî")} <br>
        <b>VA (OD/OS):</b> ${escapeHtml(va_od||"‚Äî")} / ${escapeHtml(va_os||"‚Äî")} &nbsp; | &nbsp;
        <b>IOP (OD/OS):</b> ${escapeHtml(iop_od||"‚Äî")} / ${escapeHtml(iop_os||"‚Äî")} <br>
        <b>Symptoms:</b> ${escapeHtml(sx||"‚Äî")}
      </div>
      <div style="margin-top:12px;">
        <div style="font-size:14px; font-weight:800;">Provisional Dx: ${escapeHtml(currentDx.name||currentDx.id||"‚Äî")}</div>
        <div style="font-size:12px; color:#444; margin-top:2px;">
          ${escapeHtml(currentDx.domain||"‚Äî")} ‚Ä¢ ${escapeHtml(getCategory(currentDx))}
        </div>
      </div>
      
      ${currentDx.scan_oct || currentDx.scan_octa ? `
        <div style="margin-top:12px; background:#f8fafc; padding:8px; border:1px solid #e2e8f0;">
          <div style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase;">Protocol Executed</div>
          ${currentDx.scan_oct ? `<div style="font-size:12px; margin-top:4px;"><b>OCT:</b> ${escapeHtml(currentDx.scan_oct)}</div>` : ''}
          ${currentDx.scan_octa ? `<div style="font-size:12px; margin-top:2px;"><b>OCT-A:</b> ${escapeHtml(currentDx.scan_octa)}</div>` : ''}
        </div>
      ` : ""}

      ${section("Structural OCT", oct)}
      ${section("OCT-A Protocol", octa)}
      ${section("Analysis Targets", targets)}
      ${flags.length ? section("Red Flags", flags, true) : ""}
      ${note ? `
        <div style="margin-top:16px;">
          <div style="font-size:13px; font-weight:800; color:#1d4ed8;">Clinical Impression / Plan</div>
          <div style="margin-top:4px; font-size:12px; border-left:3px solid #1d4ed8; padding-left:8px; white-space:pre-wrap;">${escapeHtml(note)}</div>
        </div>
      ` : ""}
      <div style="margin-top:14px; font-size:10px; color:#444; border-top:1px dashed #bbb; padding-top:8px;">
        Decision support tool only. Clinical correlation required. De-identify images before sharing.
      </div>
    </div>
  `;
  requestAnimationFrame(()=> { requestAnimationFrame(()=> window.print()); });
}

function section(title, items, danger=false){
  const li = items.map(x=>`<li style="margin:4px 0; list-style-type:none;">${escapeHtml(x)}</li>`).join("");
  return `
    <div style="margin-top:12px;">
      <div style="font-size:13px; font-weight:800; ${danger ? "color:#b91c1c;" : ""}">${escapeHtml(title)}</div>
      <ul style="margin:6px 0 0 0; padding:0; font-size:12px;">${li || "<li style='list-style-type:none;'>‚Äî</li>"}</ul>
    </div>
  `;
}

window.setDomain = function(dom) {
  activeDomain = dom; activeCategory = "All"; 
  document.querySelectorAll('.dTab').forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent === dom || (btn.textContent === 'All Domains' && dom === 'All')) btn.classList.add('active');
  });
  buildCategoryFilters(); applyFilters();
}

function buildCategoryFilters(){
  const bar = document.getElementById("categoryFilters");
  bar.innerHTML = "";
  let validData = window.allDiagnoses;
  if (activeDomain !== "All") validData = validData.filter(d => d.domain === activeDomain);
  const set = new Set(validData.map(d => getCategory(d)));
  const cats = ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
  cats.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "filterBtn" + (cat === activeCategory ? " active" : "");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCategory = cat;
      document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); applyFilters();
    };
    bar.appendChild(b);
  });
}

window.clearSearch = function(){
  const s = document.getElementById("search");
  if(s) s.value = "";
  applyFilters();
}

let searchTimer;
window.debouncedSearch = function() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { applyFilters(); }, 150);
}

function norm(s){ return (s || "").toString().toLowerCase().replace(/[^a-z0-9]+/g, " ").trim(); }
function searchKey(dx){ const parts = [ dx.id, dx.name, dx.domain, dx.category, ...(dx.aliases || []), ...(dx.ddx || []) ]; return norm(parts.filter(Boolean).join(" ")); }

function scoreMatch(query, key){
  if (!query) return 0;
  if (key.includes(query)) return 100;
  const qTokens = query.split(" ");
  let score = 0;
  for (const t of qTokens){ if (!t) continue; if (key.includes(t)) score += 20; }
  return score;
}

function smartFilter(data, q){
  const query = norm(q);
  if (!query) return data;
  const scored = data.map(dx => {
    const key = searchKey(dx);
    const aliasExact = (dx.aliases || []).some(a => norm(a) === query) ? 50 : 0;
    const idExact = norm(dx.id) === query ? 60 : 0;
    const nameExact = norm(dx.name) === query ? 60 : 0;
    const base = scoreMatch(query, key);
    return { dx, score: base + aliasExact + idExact + nameExact };
  });
  return scored.filter(x => x.score > 0).sort((a,b) => b.score - a.score).map(x => x.dx);
}

function applyFilters(){
  const raw = (document.getElementById("search").value || "");
  const term = raw.trim();
  let data = window.allDiagnoses.slice();
  if(activeDomain !== "All") data = data.filter(d => d.domain === activeDomain);
  if(activeCategory !== "All") data = data.filter(d => getCategory(d) === activeCategory);
  if(term) data = smartFilter(data, term);
  renderTiles(data, term);
  updateMeta(data.length, term);
}

function updateMeta(count, term){
  const meta = document.getElementById("metaLine");
  let parts = [`<b>${count}</b> protocols`];
  if(activeDomain !== "All") parts.push(`Domain: <b>${activeDomain}</b>`);
  if(activeCategory !== "All") parts.push(`Category: <b>${activeCategory}</b>`);
  if(term) parts.push(`Search: <b>${term}</b>`);
  meta.innerHTML = parts.join(" ‚Ä¢ ");
}

function renderTiles(data, term){
  const t = document.getElementById("tiles");
  t.innerHTML = "";
  if(!data.length){ t.innerHTML = "<div style='color:rgba(255,255,255,.85)'>No matching protocols found.</div>"; return; }
  data.forEach(dx=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.onmousedown = (e)=>{ tile._downSel = _hasSelection(); };
    tile.onclick = ()=>{ if(tile._downSel || _hasSelection()) return; showDetails(dx); };
    const octN = listify(dx.oct).length;
    const tarN = listify(dx.targets).length;
    const displayName = highlightTerm(dx.name || dx.id || "Untitled", term);
    tile.innerHTML = `
      <div class="tileTitle">${displayName}</div>
      <div class="catPill">${dx.domain} ‚Ä¢ ${getCategory(dx)}</div>
      <div class="countRow"><span>üì∑ OCT: ${octN}</span><span>üéØ Targets: ${tarN}</span></div>
    `;
    t.appendChild(tile);
  });
}

function setCount(id, n){ document.getElementById(id).textContent = n ? `(${n})` : ""; }

function showDetails(dx){
  const newKey = (dx?.name || dx?.id || "");
  const oldKey = (currentDx?.name || currentDx?.id || "");
  const isNew = newKey && oldKey && newKey !== oldKey;
  currentDx = dx;

  if(isNew || !oldKey) _resetObs();
  if(isNew) triageWasManuallySet = false;
  
  const panel = document.getElementById("details");
  panel.style.display = "block";
  document.getElementById("dxName").textContent = dx.name || dx.id || "";
  
  const docNotes = document.getElementById("doctorNotes");
  const pNote = document.getElementById("p_note");
  if(docNotes && pNote) docNotes.value = pNote.value || "";
  
  // SCAN INSTRUCTIONS DISPLAY
  const scanBanner = document.getElementById("scanBanner");
  const scanOctTxt = document.getElementById("scanOctTxt");
  const scanOctaTxt = document.getElementById("scanOctaTxt");
  if (dx.scan_oct || dx.scan_octa) {
      scanBanner.style.display = "block";
      scanOctTxt.innerHTML = dx.scan_oct ? `üì∑ <b>OCT:</b> <span style="font-weight:600; color:#334155;">${escapeHtml(dx.scan_oct)}</span>` : "";
      scanOctaTxt.innerHTML = dx.scan_octa ? `üß¨ <b>OCT-A:</b> <span style="font-weight:600; color:#334155;">${escapeHtml(dx.scan_octa)}</span>` : "";
      scanOctTxt.style.display = dx.scan_oct ? "block" : "none";
      scanOctaTxt.style.display = dx.scan_octa ? "block" : "none";
  } else {
      scanBanner.style.display = "none";
  }

  const o = listify(dx.oct); const a = listify(dx.octa); const t = listify(dx.targets); const f = listify(dx.red_flags);
  renderChips("octList", o, "oct");
  renderChips("octaList", a, "octa");
  renderChips("targetsList", t, "targets");
  renderChips("flagsList", f, "flags", true);
  
  setCount("octCount", o.length); setCount("octaCount", a.length); setCount("tCount", t.length); setCount("fCount", f.length);

  const ctx = _ctxFromForm();
  const initialTriage = computeTriage(dx, ctx, currentObs);
  const triSel = document.getElementById("triageSelect");
  if(!triageWasManuallySet){ if(triSel) triSel.value = initialTriage.level; }
  updateDecisionBadgeFromSelect();
  if(!triageWasManuallySet) {
     const badge = document.getElementById("decisionBadge");
     if(badge) badge.title = initialTriage.reason;
  }
  renderDDX(dx);
  updateActivePatientBanner();
  if (window.matchMedia("(max-width: 920px)").matches) panel.scrollIntoView({behavior:"smooth", block:"start"});
}

window.collapseDetails = function(){
  document.getElementById("details").style.display = "none";
  currentDx = null; triageWasManuallySet = false;
}

function updateActivePatientBanner() {
  const banner = document.getElementById("activePatientBanner");
  if(!banner) return;
  const pid = (document.getElementById("p_id")?.value || "").trim();
  const va_od = (document.getElementById("p_va_od")?.value || "").trim();
  const va_os = (document.getElementById("p_va_os")?.value || "").trim();
  const iop_od = (document.getElementById("p_iop_od")?.value || "").trim();
  const iop_os = (document.getElementById("p_iop_os")?.value || "").trim();
  if(!pid) { banner.style.display = "none"; return; }
  const bits = [];
  bits.push(`<strong>${escapeHtml(pid)}</strong>`);
  if(va_od || va_os) bits.push(`VA: ${escapeHtml(va_od||'-')}/${escapeHtml(va_os||'-')}`);
  if(iop_od || iop_os) bits.push(`IOP: ${escapeHtml(iop_od||'-')}/${escapeHtml(iop_os||'-')}`);
  banner.innerHTML = `<span style="color:#64748b; margin-right:8px;">Active Patient:</span> ` + bits.join(' <span style="color:#cbd5e1; margin:0 6px;">|</span> ');
  banner.style.display = "block";
}

function getFindingsState(){
  const wrap = document.getElementById("findingsWrap") || document;
  const state = {};
  wrap.querySelectorAll("input[type=checkbox][data-finding]").forEach(cb=>{ state[cb.dataset.finding] = !!cb.checked; });
  return state;
}

function decisionFromTriage(level){
  if(level==="Urgent") return {badge:"URGENT REFER"};
  if(level==="Soon") return {badge:"TREAT / REFER SOON"};
  return {badge:"OBSERVE / ROUTINE"};
}

function evalCond(cond, ctx){
  if (!cond) return true;
  if (cond.flag){
    const v = !!ctx?.[cond.flag] || !!ctx?.find?.[cond.flag];
    return ("is" in cond) ? (v === !!cond.is) : v;
  }
  return false;
}

function computeDDX(primaryDx, ctx){
  const all = window.allDiagnoses.map(d=>d.name);
  const out = [];
  const push = (name, reason, w=0)=>{
    const actualDx = window.allDiagnoses.find(d => d.name === name || d.id === name || (d.aliases && d.aliases.includes(name)));
    if (!actualDx || actualDx.name === primaryDx.name) return;
    const ex = out.find(x=>x.name===actualDx.name);
    if (ex) { ex.w += w; return; }
    out.push({name: actualDx.name, reason, w, targetDx: actualDx});
  };
  if (Array.isArray(primaryDx.ddx_rules)) {
    primaryDx.ddx_rules.forEach(rule=>{ 
      let match = false;
       if (rule.when) {
         if (rule.when.chip_contains) {
             const bucket = currentObs[rule.when.bucket || "targets"] || {};
             match = Object.entries(bucket).some(([k,v]) => v && k.includes(norm(rule.when.chip_contains)));
         } else if (rule.when.flag) {
             match = evalCond(rule.when, ctx);
         }
       }
       if (match) push(rule.candidate, rule.reason, rule.weight || 5);
    });
  }
  if (Array.isArray(primaryDx.ddx)) { primaryDx.ddx.forEach(n=>push(n, "Listed DDx", 1)); }
  const n = (primaryDx.name||"").toLowerCase();
  if (n.includes("npdr")) {
    push("Diabetic Macular Edema (DME)", "Rule out coexisting DME", ctx.dm?6:3);
    push("Branch Retinal Vein Occlusion (BRVO)", "Hemorrhage mimic", ctx.htn?4:1);
  }
  out.sort((a,b)=> (b.w||0)-(a.w||0));
  return out.slice(0, 5);
}

function renderDDX(primaryDx){
  const wrap = document.getElementById("ddxChips");
  if (!wrap) return;
  wrap.innerHTML = "";
  const ctx = _ctxFromForm();
  const ddx = computeDDX(primaryDx, ctx);
  if (!ddx.length) { wrap.innerHTML = '<span class="hint">No automatic DDx generated.</span>'; return; }
  ddx.forEach(x=>{
    const b = document.createElement("div");
    b.className = "ddx-chip";
    if(x.w > 2) {
       b.style.borderColor = "#f59e0b"; b.style.color = "#d97706"; b.style.background = "#fef3c7";
       b.innerHTML = `üí° Switch to: ${escapeHtml(x.name)}`;
    } else {
       b.textContent = x.name;
    }
    b.title = x.reason || "Open protocol";
    b.onclick = ()=>{ if (x.targetDx) showDetails(x.targetDx); };
    wrap.appendChild(b);
  });
}

function _loadStore(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '{"patients":{}}'); } catch(e){ return {"patients":{}}; } }
function _saveStore(store){ localStorage.setItem(LS_KEY, JSON.stringify(store)); }
function _nowISO(){ return new Date().toISOString(); }

function _ctxFromForm(){
  const symptoms = (document.getElementById("p_symptoms")?.value || "").toLowerCase();
  const dm = !!document.getElementById("p_dm")?.checked;
  const htn = !!document.getElementById("p_htn")?.checked;
  const find = getFindingsState();
  find.diabetes = dm; find.htn = htn; find.hypertension = htn; find.dm = dm;
  return { dm, htn, sudden: /sudden|today|yesterday|since morning/.test(symptoms), pain: /pain|ache|headache/.test(symptoms), symptoms: symptoms, find };
}

function _getPatientForm(){
  const flags = {
    dm: !!document.getElementById("p_dm")?.checked, htn: !!document.getElementById("p_htn")?.checked,
    myopia: !!document.getElementById("p_myopia")?.checked, steroid: !!document.getElementById("p_steroid")?.checked,
    smoke: !!document.getElementById("p_smoke")?.checked, ...getFindingsState()
  };
  return {
    id: (document.getElementById("p_id")?.value || "").trim(), age: (document.getElementById("p_age")?.value || "").trim(),
    sex: (document.getElementById("p_sex")?.value || "").trim(), va_od: (document.getElementById("p_va_od")?.value || "").trim(),
    va_os: (document.getElementById("p_va_os")?.value || "").trim(), iop_od: (document.getElementById("p_iop_od")?.value || "").trim(),
    iop_os: (document.getElementById("p_iop_os")?.value || "").trim(), note: (document.getElementById("p_note")?.value || "").trim(),
    symptoms: (document.getElementById("p_symptoms")?.value || "").trim(), flags
  };
}

window.openPatients = function(fromDx=false){
  if(fromDx && !currentDx) fromDx = false;
  autoSaveVisitOnPatientSave = !!fromDx;
  document.getElementById("drawerOverlay").classList.add("open");
  document.getElementById("patientDrawer").classList.add("open");
  renderPatientList();
  const last = localStorage.getItem(LS_KEY + "_last");
  if(last){ const store = _loadStore(); if(store.patients && store.patients[last]) loadPatient(last); }
  const hint = document.getElementById("activeDxHint");
  if (fromDx && currentDx){ hint.style.display="block"; hint.textContent = `Ready to link to: ${currentDx.name || currentDx.id}`; } 
  else { hint.style.display="none"; }
}

window.closePatients = function(ev){
  if(ev && ev.target && ev.target.id !== "drawerOverlay") return;
  document.getElementById("drawerOverlay").classList.remove("open");
  document.getElementById("patientDrawer").classList.remove("open");
}

window.clearPatientForm = function(){
  document.querySelectorAll(".drawer-body input, .drawer-body select").forEach(el => {
    if(el.type === 'checkbox') el.checked = false; else el.value = "";
  });
  document.getElementById("visitTimelinePanel").style.display = "none";
  document.getElementById("overdueAlert").style.display = "none";
  const docNotes = document.getElementById("doctorNotes");
  if(docNotes) docNotes.value = "";
  updateActivePatientBanner();
  if(currentDx) {
    if(!triageWasManuallySet) {
       const initialTriage = computeTriage(currentDx, _ctxFromForm(), currentObs);
       const triSel = document.getElementById("triageSelect");
       if(triSel) triSel.value = initialTriage.level;
    }
    updateDecisionBadgeFromSelect();
  }
}

window.savePatientAndMaybeVisit = function(){
  const form = _getPatientForm();
  if(!form.id){ alert("Please enter Patient ID / OPD No."); return; }
  const store = _loadStore(); store.patients = store.patients || {};
  const existing = store.patients[form.id] || { id: form.id, createdAt: _nowISO(), visits: [] };
  existing.age = form.age; existing.sex = form.sex; existing.va_od = form.va_od; existing.va_os = form.va_os;
  existing.iop_od = form.iop_od; existing.iop_os = form.iop_os; existing.note = form.note;
  existing.symptoms = form.symptoms; existing.flags = form.flags; existing.updatedAt = _nowISO();
  let loggedThisTime = false;

  if (autoSaveVisitOnPatientSave && currentDx){
    const triage = document.getElementById("triageSelect")?.value || "Routine";
    const dxKey = currentDx.name || currentDx.id || "‚Äî";
    const lastVisit = (existing.visits || [])[0];
    const lastT = lastVisit && lastVisit.at ? new Date(lastVisit.at).getTime() : NaN;
    const tooSoon = lastVisit && lastVisit.dx === dxKey && isFinite(lastT) && (Date.now() - lastT) < 2*60*1000;
    if (!tooSoon) {
      existing.visits.unshift({
        at: _nowISO(), dx: dxKey, domain: currentDx.domain || "‚Äî", category: getCategory(currentDx),
        triage, decision: decisionFromTriage(triage).badge, va_od: form.va_od, va_os: form.va_os,
        iop_od: form.iop_od, iop_os: form.iop_os, note: form.note,
        findings: JSON.parse(JSON.stringify(currentObs)) 
      });
      existing.visits = existing.visits.slice(0, 30);
      loggedThisTime = true;
    }
    autoSaveVisitOnPatientSave = false;
  }
  store.patients[form.id] = existing; _saveStore(store); updateActivePatientBanner();
  const hint = document.getElementById("activeDxHint");
  hint.style.display = "block";
  hint.textContent = loggedThisTime ? `Saved + Visit logged for: ${currentDx.name || currentDx.id}` : "Patient context saved.";
  document.getElementById("overdueAlert").style.display = "none";
  window.renderPatientList(); renderVisitTimeline(existing);
  document.getElementById("visitTimelinePanel")?.scrollIntoView({behavior:"smooth", block:"start"});
}

window.renderPatientList = function(){
  const store = _loadStore(); const list = document.getElementById("patientList"); if(!list) return;
  const q = (document.getElementById("patientSearch")?.value || "").trim().toLowerCase();
  const patients = store.patients || {}; let ids = Object.keys(patients);
  if(q) ids = ids.filter(id => id.toLowerCase().includes(q));
  if(ids.length===0){ list.innerHTML = `<div style="color:#94a3b8; font-size:12px; padding:6px;">No patients found.</div>`; return; }
  ids.sort((a,b)=>{
    const A = patients[a]?.updatedAt || patients[a]?.createdAt || "";
    const B = patients[b]?.updatedAt || patients[b]?.createdAt || "";
    return (B > A) ? 1 : (B < A ? -1 : 0);
  });
  list.innerHTML = "";
  ids.forEach(pid=>{
    const p = patients[pid]; const vCount = (p.visits || []).length;
    const el = document.createElement("div"); el.className = "item";
    el.innerHTML = `
      <div style="flex:1; min-width:0;">
        <strong>${escapeHtml(pid)}</strong>
        <div style="margin-top:4px;">
          <small>${escapeHtml([p.age?`Age ${p.age}`:"", p.sex||""].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî")}</small>
          <small style="display:block; margin-top:2px;">Visits: ${vCount} ‚Ä¢ Updated: ${escapeHtml((p.updatedAt||p.createdAt||"").slice(0,19).replace("T"," "))}</small>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button type="button" class="loadBtn" style="background:#2563eb; color:#fff;" data-pid="${escapeAttr(pid)}">Load</button>
        <button type="button" class="delBtn" style="background:#ef4444; color:#fff;" data-pid="${escapeAttr(pid)}">Delete</button>
      </div>
    `;
    el.querySelector(".loadBtn").addEventListener("click", (e)=> loadPatient(e.currentTarget.dataset.pid));
    el.querySelector(".delBtn").addEventListener("click", (e)=> deletePatient(e.currentTarget.dataset.pid));
    list.appendChild(el);
  });
}

function loadPatient(pid){
  const store = _loadStore(); const p = store.patients?.[pid]; if(!p) return;
  document.getElementById("p_id").value = p.id || pid;
  document.getElementById("p_age").value = p.age || "";
  document.getElementById("p_sex").value = p.sex || "";
  document.getElementById("p_va_od").value = p.va_od || "";
  document.getElementById("p_va_os").value = p.va_os || "";
  document.getElementById("p_iop_od").value = p.iop_od || "";
  document.getElementById("p_iop_os").value = p.iop_os || "";
  document.getElementById("p_note").value = p.note || "";
  const docNotes = document.getElementById("doctorNotes"); if(docNotes) docNotes.value = p.note || "";
  document.getElementById("p_symptoms").value = p.symptoms || "";

  const flags = p.flags || {};
  const map = { dm:"p_dm", htn:"p_htn", myopia:"p_myopia", steroid:"p_steroid", smoke:"p_smoke" };
  Object.keys(map).forEach(k=>{ const el = document.getElementById(map[k]); if(el) el.checked = !!flags[k]; });
  const wrap = document.getElementById("findingsWrap") || document;
  wrap.querySelectorAll("input[type=checkbox][data-finding]").forEach(cb=>{ cb.checked = !!flags[cb.dataset.finding]; });
  
  updateActivePatientBanner();
  const overdueAlert = document.getElementById("overdueAlert"); overdueAlert.style.display = "none";
  if (p.visits && p.visits.length > 0) {
      const lastV = p.visits[0];
      if (lastV && lastV.at) {
          const daysSince = Math.floor((Date.now() - new Date(lastV.at).getTime()) / (1000 * 60 * 60 * 24));
          let overdue = false; const dxLower = (lastV.dx || "").toLowerCase();
          if (dxLower.match(/brvo|crvo|dme|cnv|wet amd|macular edema/)) { if (daysSince > 45) overdue = true; } 
          else if (dxLower.match(/glaucoma|suspect/)) { if (daysSince > 90) overdue = true; } 
          else {
              if (lastV.triage === "Urgent" && daysSince > 3) overdue = true;
              if (lastV.triage === "Soon" && daysSince > 45) overdue = true;
              if (lastV.triage === "Routine" && daysSince > 180) overdue = true;
          }
          if (overdue) {
              overdueAlert.style.display = "block";
              overdueAlert.innerHTML = `‚ö†Ô∏è Follow-up Overdue (${daysSince} days since last visit)`;
          }
      }
  }
  renderVisitTimeline(p);
  if(currentDx) {
    if(!triageWasManuallySet) {
       const initialTriage = computeTriage(currentDx, _ctxFromForm(), currentObs);
       const triSel = document.getElementById("triageSelect");
       if(triSel) triSel.value = initialTriage.level;
    }
    updateDecisionBadgeFromSelect();
  }
  localStorage.setItem(LS_KEY + "_last", pid);
  document.getElementById("p_symptoms")?.focus();
}

function deletePatient(pid){
  const confirmation = prompt(`To delete patient "${pid}", type the exact ID below:`);
  if(confirmation !== pid) { if (confirmation !== null) alert("ID did not match. Deletion cancelled."); return; }
  const store = _loadStore();
  if(store.patients && store.patients[pid]){
    delete store.patients[pid]; _saveStore(store); window.clearPatientForm(); window.renderPatientList();
    const last = localStorage.getItem(LS_KEY + "_last"); if(last === pid) localStorage.removeItem(LS_KEY + "_last");
  }
}

function renderVisitTimeline(p) {
  const panel = document.getElementById("visitTimelinePanel");
  const list = document.getElementById("visitTimelineList");
  if(!p || !p.visits || !p.visits.length) { panel.style.display = "none"; return; }
  panel.style.display = "block"; list.innerHTML = "";
  
  (p.visits || []).slice(0, 10).forEach((v, i) => {
    const el = document.createElement("div"); el.className = "item";
    let badgeColor = "rgba(255,255,255,0.1)";
    if(v.triage === "Urgent") badgeColor = "rgba(220, 38, 38, 0.2)"; 
    if(v.triage === "Soon") badgeColor = "rgba(202, 138, 4, 0.2)"; 
    const d = new Date(v.at); const ds = isNaN(d) ? String(v.at||"").slice(0,10) : d.toLocaleDateString();
    let metrics = [];
    if(v.va_od || v.va_os) metrics.push(`VA: ${v.va_od||'-'}/${v.va_os||'-'}`);
    if(v.iop_od || v.iop_os) metrics.push(`IOP: ${v.iop_od||'-'}/${v.iop_os||'-'}`);
    const metricStr = metrics.length ? `<div style="margin-top:4px; font-size:11px; color:#cbd5e1;">${escapeHtml(metrics.join(" | "))}</div>` : "";
    const noteStr = v.note ? `<div style="margin-top:2px; font-size:11px; color:#94a3b8; font-style:italic;">"${escapeHtml(v.note)}"</div>` : "";

    let activeFindings = [];
    if(v.findings) {
       let fCount = Object.values(v.findings.flags||{}).filter(Boolean).length;
       let tCount = Object.values(v.findings.targets||{}).filter(Boolean).length;
       let oCount = Object.values(v.findings.oct||{}).filter(Boolean).length;
       let oaCount = Object.values(v.findings.octa||{}).filter(Boolean).length;
       let total = fCount + tCount + oCount + oaCount;
       if(total > 0) {
           let str = `Findings: ${total}`;
           if(fCount>0) str += ` <span style="color:#ef4444; font-weight:bold;">(${fCount} flags)</span>`;
           activeFindings.push(str);
       }
    }
    const findingStr = activeFindings.length ? `<div style="margin-top:2px; font-size:10px; color:#fbbf24;">${activeFindings.join("")}</div>` : "";

    el.innerHTML = `
      <div style="flex:1;">
        <strong style="color:#e2e8f0;">${escapeHtml(v.dx)}</strong> 
        <span style="font-size:10px; padding:2px 6px; border-radius:4px; background:${badgeColor}; margin-left:6px;">${escapeHtml(v.triage)}</span>
        ${metricStr} ${noteStr} ${findingStr}
        <div style="margin-top:4px; font-size:10px; color:#64748b;">Recorded: ${escapeHtml(ds)}</div>
      </div>
      <button type="button" class="reopenBtn" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2);" data-dx="${escapeAttr(v.dx)}" data-vi="${i}">Reopen</button>
    `;
    el.querySelector(".reopenBtn").addEventListener("click", (e)=>{
      const dxKey = e.currentTarget.dataset.dx; const vi = parseInt(e.currentTarget.dataset.vi, 10);
      reopenDx(dxKey, p.visits[vi]?.findings);
    });
    list.appendChild(el);
  });
}

function reopenDx(key, findings) {
  const k = (key || "").trim(); const dx = window.allDiagnoses.find(d => d.name === k || d.id === k);
  if(!dx) return alert("Protocol not found in current database.");
  window.closePatients(); showDetails(dx); 

  function _upgradeFindingKeys(bucket){
    const o = currentObs[bucket] || {}; const upgraded = {};
    Object.keys(o).forEach(k=>{ upgraded[norm(k)] = !!o[k]; });
    currentObs[bucket] = upgraded;
  }

  if(findings) {
    currentObs = JSON.parse(JSON.stringify(findings));
    ["oct","octa","targets","flags"].forEach(_upgradeFindingKeys);
    const o = listify(dx.oct), a = listify(dx.octa), t = listify(dx.targets), f = listify(dx.red_flags);
    renderChips("octList", o, "oct"); renderChips("octaList", a, "octa");
    renderChips("targetsList", t, "targets"); renderChips("flagsList", f, "flags", true);
    autoTriageFromObservations();
  }
}

window.exportPatients = function(){
  const store = _loadStore(); const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `oct_patients_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

window.importPatients = function(){
  const inp = document.createElement("input"); inp.type = "file"; inp.accept = "application/json";
  inp.onchange = async () => {
    const f = inp.files?.[0]; if(!f) return;
    try{
      const text = await f.text(); const data = JSON.parse(text);
      if(!data || typeof data !== "object" || !data.patients) throw new Error("Invalid file");
      const current = _loadStore(); current.patients = current.patients || {};
      const incoming = data.patients || {};
      Object.keys(incoming).forEach(id=>{ current.patients[id] = incoming[id]; });
      _saveStore(current); window.renderPatientList(); alert("Import successful (merged with existing).");
    } catch(e){ alert("Import failed: invalid backup file."); }
  };
  inp.click();
}

document.addEventListener("DOMContentLoaded", ()=>{ 
  updateDecisionBadgeFromSelect(); 
  
  document.querySelectorAll(".drawer-body input, .drawer-body select").forEach(el=>{
    el.addEventListener("change", () => {
      if(currentDx){
        if(!triageWasManuallySet) {
          const initialTriage = computeTriage(currentDx, _ctxFromForm(), currentObs);
          const triSel = document.getElementById("triageSelect");
          if(triSel) triSel.value = initialTriage.level;
        }
        updateDecisionBadgeFromSelect();
      }
    });
    el.addEventListener("input", () => { updateActivePatientBanner(); });
  });
  
  document.getElementById("search")?.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ clearTimeout(searchTimer); applyFilters(); }
  });

  document.getElementById("triageSelect")?.addEventListener("change", ()=>{
    triageWasManuallySet = true;
    const badge = document.getElementById("decisionBadge");
    if(badge) badge.title = "Manual override";
    updateDecisionBadgeFromSelect();
  });
});
</script>
</body>
</html>